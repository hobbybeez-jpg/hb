<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobby Bee 排班工具（正式版：週日為每週第一天）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .calendar-inner { display: inline-block; transform-origin: top left; }
  </style>
</head>

<body class="bg-slate-50">
  <!-- safelist：確保 Tailwind 生成以下顏色類別供 JS 動態套用（強對比組合） -->
  <div class="hidden" aria-hidden="true">
    <span class="bg-red-200 border-red-700 text-red-900"></span>
    <span class="bg-orange-200 border-orange-700 text-orange-900"></span>
    <span class="bg-amber-200 border-amber-700 text-amber-900"></span>
    <span class="bg-emerald-200 border-emerald-700 text-emerald-900"></span>
    <span class="bg-teal-200 border-teal-700 text-teal-900"></span>
    <span class="bg-blue-200 border-blue-700 text-blue-900"></span>
    <span class="bg-violet-200 border-violet-700 text-violet-900"></span>
    <span class="bg-rose-200 border-rose-700 text-rose-900"></span>
    <span class="bg-cyan-200 border-cyan-700 text-cyan-900"></span>
    <span class="bg-indigo-200 border-indigo-700 text-indigo-900"></span>
    <span class="bg-lime-200 border-lime-700 text-lime-900"></span>
    <span class="bg-fuchsia-200 border-fuchsia-700 text-fuchsia-900"></span>
    <span class="bg-pink-200 border-pink-700 text-pink-900"></span>
    <span class="bg-purple-200 border-purple-700 text-purple-900"></span>
    <span class="bg-sky-200 border-sky-700 text-sky-900"></span>
    <span class="bg-slate-200 border-slate-700 text-slate-900"></span>
    <span class="bg-stone-200 border-stone-700 text-stone-900"></span>
    <span class="bg-green-200 border-green-700 text-green-900"></span>
  </div>

  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState, useLayoutEffect } = React;

    // === Utils（週日為每週第一天） ===
    const ymKey = (y, m) => `${y}-${String(m + 1).padStart(2, '0')}`; // m:0-11
    const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
    const getDOW = (y, m, d) => new Date(y, m, d).getDay(); // 0..6 Sun..Sat
    const isWeekend = (y, m, d) => { const dow = getDOW(y, m, d); return dow === 0 || dow === 6; };
    const hoursForDate = (y, m, d) => (isWeekend(y, m, d) ? 6 : 7);
    const dateStr = (y,m,d) => `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    const encodeShare = (obj) => btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    const decodeShare = (str) => JSON.parse(decodeURIComponent(escape(atob(str))));

    const DISTINCT_KEYS = ['red','orange','amber','emerald','teal','blue','violet'];
    const EXTENDED_KEYS = [...DISTINCT_KEYS,'rose','cyan','indigo','lime','fuchsia','pink','purple','sky','slate','stone','green'];
    const colorClassForKey = (key) => `bg-${key}-200 border-${key}-700 text-${key}-900`;

    function hashStr(s){ let h = 2166136261 >>> 0; for (let i=0; i<s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); } return h >>> 0; }
    function computeColorMap(employees, existingMap={}){
      const ids = new Set(employees.map(e=>e.id));
      const map = {}; Object.keys(existingMap||{}).forEach(id=>{ if(ids.has(+id)||ids.has(id)) map[id]=existingMap[id]; });
      const used = new Set(Object.values(map));
      const unassigned = employees.filter(e=>map[e.id]==null).slice().sort((a,b)=>{
        const ha = hashStr(String(a.name||'').toLowerCase());
        const hb = hashStr(String(b.name||'').toLowerCase());
        return ha - hb;
      });
      const pickKey = () => {
        for(const k of DISTINCT_KEYS){ if(!used.has(k)) { used.add(k); return k; } }
        for(const k of EXTENDED_KEYS){ if(!used.has(k)) { used.add(k); return k; } }
        const arr = EXTENDED_KEYS; return arr[(used.size) % arr.length];
      };
      unassigned.forEach(e=>{ map[e.id] = pickKey(); });
      return map;
    }

    function buildMonthMatrix(year, month){
      const total = daysInMonth(year, month);
      const firstDow = new Date(year, month, 1).getDay(); // 0..6 Sun..Sat
      const leading = firstDow; // 週日置前
      const slots = leading + total;
      const weekCount = Math.ceil(slots / 7);
      const weeks = Array.from({length: weekCount}, ()=> Array(7).fill(null).map(()=>({type:'pad'})));
      let day = 1;
      for(let w=0; w<weekCount; w++){
        for(let dow=0; dow<7; dow++){
          const index = w*7 + dow;
          if(index >= leading && day <= total){
            weeks[w][dow] = {type:'day', d: day};
            day++;
          }
        }
      }
      return { weeks, weekCount };
    }

    function ScaleBox({ children, maxScale=1 }){
      const wrapRef = useRef(null);
      const innerRef = useRef(null);
      const [height, setHeight] = useState(null);
      useLayoutEffect(()=>{
        const wrap = wrapRef.current; const inner = innerRef.current; if(!wrap||!inner) return;
        const update = () => {
          inner.style.transform = 'scale(1)';
          const iw = inner.scrollWidth || inner.offsetWidth;
          const ih = inner.scrollHeight || inner.offsetHeight;
          const ww = wrap.clientWidth;
          const s = iw ? Math.min(ww/iw, maxScale) : 1;
          inner.style.transform = `scale(${s})`;
          setHeight(ih * s);
        };
        const ro = new ResizeObserver(update);
        ro.observe(wrap); ro.observe(inner);
        window.addEventListener('resize', update);
        update();
        return ()=>{ ro.disconnect(); window.removeEventListener('resize', update); };
      },[]);
      return (
        <div ref={wrapRef} className="w-full" style={{position:'relative', height: height?`${height}px`:'auto'}}>
          <div ref={innerRef} className="calendar-inner">{children}</div>
        </div>
      );
    }

    // ===== Netlify Blobs API（Functions 代理） =====
    const REMOTE_KEY = 'hb-default';
    const API_BASE = '/.netlify/functions/schedule';

    async function loadRemoteAll() {
      try { const res = await fetch(`${API_BASE}?key=${encodeURIComponent(REMOTE_KEY)}`); if (!res.ok) return null; return await res.json(); }
      catch { return null; }
    }
    async function saveRemoteAll(payload) {
      const res = await fetch(`${API_BASE}?key=${encodeURIComponent(REMOTE_KEY)}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!res.ok && res.status !== 204) throw new Error('儲存失敗');
    }

    // ===== Portal：休假彈窗置頂 =====
    function Portal({ children }){
      const [node] = useState(()=> document.createElement('div'));
      useEffect(()=>{ document.body.appendChild(node); return ()=>{ document.body.removeChild(node); }; }, [node]);
      return ReactDOM.createPortal(children, node);
    }

    // ===== 放大版休假 Popover（週日置前） =====
    function VacationPopover({ emp, anchor, baseYear, baseMonth, onClose, isVacation, toggleVacation }) {
      const [off, setOff] = useState(0);
      const cur = new Date(baseYear, baseMonth + off, 1);
      const y = cur.getFullYear();
      const m = cur.getMonth();

      const [pos, setPos] = useState({ left: 0, top: 0 });
      useEffect(()=>{
        const PADDING = 12;
        const width = Math.min(window.innerWidth * 0.92, 560);
        const height = 380;
        let left = anchor.x; let top = anchor.y;
        if (left + width + PADDING > window.innerWidth) left = window.innerWidth - width - PADDING;
        if (top + height + PADDING > window.innerHeight) top = window.innerHeight - height - PADDING;
        if (left < PADDING) left = PADDING; if (top < PADDING) top = PADDING;
        setPos({ left, top });
      }, [anchor]);

      useEffect(()=>{
        const onKey = (e)=>{ if(e.key==='Escape') onClose(); };
        const onScroll = ()=> onClose();
        window.addEventListener('keydown', onKey);
        window.addEventListener('scroll', onScroll, { passive: true });
        return ()=>{ window.removeEventListener('keydown', onKey); window.removeEventListener('scroll', onScroll); };
      }, [onClose]);

      const { weeks } = useMemo(()=>buildMonthMatrix(y, m), [y, m]);

      return (
        <Portal>
          <div className="fixed inset-0 z-[99998]">
            <div className="absolute inset-0" onClick={onClose}></div>
            <div className="absolute z-[99999] p-4 bg-white border rounded-2xl shadow-2xl"
                 style={{ left: pos.left, top: pos.top, width: Math.min(window.innerWidth*0.92, 560) }}>
              <div className="flex items-center justify-between mb-3">
                <div className="text-base font-semibold text-slate-800">{emp.name} 的休假日</div>
                <div className="flex items-center gap-1">
                  <button className="px-2 py-1 rounded-lg border hover:bg-slate-50" title="上一月" onClick={()=>setOff(off-1)}>◀</button>
                  <div className="px-2 text-slate-700 font-medium">{y} 年 {String(m+1).padStart(2,'0')} 月</div>
                  <button className="px-2 py-1 rounded-lg border hover:bg-slate-50" title="下一月" onClick={()=>setOff(off+1)}>▶</button>
                  <button className="ml-2 px-2 py-1 rounded-lg border text-slate-500 hover:text-slate-700 hover:bg-slate-50" onClick={onClose} title="關閉">✕</button>
                </div>
              </div>
              <div className="grid grid-cols-7 gap-2 text-center text-sm text-slate-500 mb-2">
                {['日','一','二','三','四','五','六'].map((w)=> <div key={w} className="font-medium">{w}</div>)}
              </div>
              <div className="grid grid-cols-7 gap-2">
                {weeks.flat().map((c, idx) => c.type === 'pad' ? (
                  <div key={idx} className="h-10"></div>
                ) : (
                  <button key={idx}
                    onClick={()=>toggleVacation(emp.id, y, m, c.d)}
                    className={
                      "h-10 w-10 md:h-12 md:w-12 rounded-lg text-base md:text-lg leading-none flex items-center justify-center select-none transition " +
                      (isVacation(emp.id, y, m, c.d)
                       ? "bg-rose-100 border border-rose-500 text-rose-700 shadow-[inset_0_0_0_1px_rgba(244,63,94,0.2)]"
                       : "border border-slate-200 hover:bg-slate-50")}
                    title="點擊切換休假"
                  >{c.d}</button>
                ))}
              </div>
              <div className="mt-3 text-xs text-slate-500 flex items-center justify-between">
                <span>提示：紅色為休假，不可排班。按 ESC 或背景關閉。</span>
                <button className="px-2 py-1 rounded border hover:bg-slate-50" onClick={()=>setOff(0)}>回到本月</button>
              </div>
            </div>
          </div>
        </Portal>
      );
    }

    // ===== 每日職位 S/P/F/M + others（可拖曳排序） =====
    const ROLE_KEYS = ['S','P','F','M'];

    function normalizeDayEntry(entry){
      if (!entry) return { roles: { S:null, P:null, F:null, M:null }, others: [] };

      // 舊格式：陣列 [empId...]
      if (Array.isArray(entry)) {
        const roles = { S:null, P:null, F:null, M:null };
        const others = [];
        entry.forEach((id, idx) => {
          const rk = ROLE_KEYS[idx];
          if (rk) roles[rk] = id;
          else others.push(id);
        });
        return { roles, others };
      }

      // 新格式
      const roles = entry.roles || {};
      return {
        roles: {
          S: roles.S ?? null,
          P: roles.P ?? null,
          F: roles.F ?? null,
          M: roles.M ?? null
        },
        others: Array.isArray(entry.others) ? entry.others : []
      };
    }

    function removeEmpFromDayEntry(dayEntry, empId){
      const next = normalizeDayEntry(dayEntry);
      ROLE_KEYS.forEach(rk => { if (next.roles[rk] === empId) next.roles[rk] = null; });
      next.others = (next.others || []).filter(id => id !== empId);
      return next;
    }

    function hasEmpInDayEntry(dayEntry, empId){
      const d = normalizeDayEntry(dayEntry);
      if (ROLE_KEYS.some(rk => d.roles[rk] === empId)) return true;
      return (d.others || []).includes(empId);
    }

    function addEmpToDayEntry(dayEntry, empId, preferredRole=null){
      const next = normalizeDayEntry(dayEntry);
      if (hasEmpInDayEntry(next, empId)) return next;

      if (preferredRole && ROLE_KEYS.includes(preferredRole) && !next.roles[preferredRole]) {
        next.roles[preferredRole] = empId;
        return next;
      }

      // 預設順序：S -> P -> F -> M
      for (const rk of ROLE_KEYS) {
        if (!next.roles[rk]) {
          next.roles[rk] = empId;
          return next;
        }
      }

      next.others = [...(next.others || []), empId];
      return next;
    }

    function App() {
      // 預設 2025-09
      const [year, setYear] = useState(2025);
      const [month, setMonth] = useState(8);

      const [nameInput, setNameInput] = useState("");
      const [employees, setEmployees] = useState([]);
      const [assignments, setAssignments] = useState({}); // 當月：day -> dayEntry
      const [assignmentsByYM, setAssignmentsByYM] = useState({}); // 全部月份
      const [colorMap, setColorMap] = useState({});
      const [vacations, setVacations] = useState({}); // { [empId]: { 'YYYY-MM-DD': true } }

      const [highlightEmpId, setHighlightEmpId] = useState(null);
      const [readOnly, setReadOnly] = useState(false);
      const [saved, setSaved] = useState(false);

      const [vacEditEmp, setVacEditEmp] = useState(null); // {emp, anchor:{x,y}}

      // 解析唯讀/分享
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        setReadOnly(params.get('readOnly') === '1');
        const hash = window.location.hash || '';
        if (hash.startsWith('#s=')) {
          try {
            const payload = decodeShare(hash.slice(3));
            if (payload && (payload.v === 1 || payload.v === 2)) {
              setYear(payload.year); setMonth(payload.month);
              setEmployees(payload.employees || []);
              if (payload.assignmentsByYM) {
                setAssignmentsByYM(payload.assignmentsByYM);
                setAssignments(payload.assignmentsByYM[ymKey(payload.year, payload.month)] || {});
              } else {
                setAssignments(payload.assignments || {});
              }
              setColorMap(payload.colorMap || {});
              setVacations(payload.vacations || {});
              setReadOnly(true);
            }
          } catch (e) { console.warn('共享連結解析失敗', e); }
        }
      }, []);

      // 啟動時嘗試載入雲端資料
      useEffect(() => {
        (async () => {
          const remote = await loadRemoteAll();
          if (remote) {
            setEmployees(remote.employees || []);
            setColorMap(remote.colorMap || {});
            setVacations(remote.vacations || {});
            const byYM = remote.assignmentsByYM || {};
            setAssignmentsByYM(byYM);
            setAssignments(byYM[ymKey(year, month)] || {});
          }
        })();
      }, []);

      // 員工顏色保持穩定
      useEffect(() => {
        const next = computeColorMap(employees, colorMap);
        if (JSON.stringify(next) !== JSON.stringify(colorMap)) setColorMap(next);
      }, [employees]);

      // 切換月份時載入當月資料（來自 assignmentsByYM）
      useEffect(() => {
        setAssignments(assignmentsByYM[ymKey(year, month)] || {});
      }, [year, month, assignmentsByYM]);

      const { weeks } = useMemo(()=>buildMonthMatrix(year, month), [year, month]);

      const isVacation = (empId, y, m, d) => !!vacations?.[empId]?.[dateStr(y,m,d)];
      const toggleVacation = (empId, y, m, d) => {
        setVacations(prev => {
          const ds = dateStr(y,m,d);
          const cur = { ...(prev[empId] || {}) };
          if (cur[ds]) delete cur[ds]; else cur[ds] = true;
          return { ...prev, [empId]: cur };
        });
      };

      const saveRemote = async () => {
        const ym = ymKey(year, month);
        const merged = { ...assignmentsByYM, [ym]: assignments };
        const payload = { employees, colorMap, vacations, assignmentsByYM: merged };
        await saveRemoteAll(payload);
        setAssignmentsByYM(merged);
        setSaved(true); setTimeout(()=>setSaved(false), 1500);
      };

      const monthLabel = (y, m) => `${y} 年 ${String(m+1).padStart(2,'0')} 月`;
      const abbr = (name) => (name || '').trim().slice(0,3).toUpperCase();

      const getEmpColor = (empId) => {
        const key = colorMap[empId];
        return colorClassForKey(key || 'emerald');
      };

      const addEmployee = () => {
        if (readOnly) return;
        const name = nameInput.trim(); if (!name) return;
        const id = Date.now() + Math.random();
        const newEmp = { id, name };
        const nextEmployees = [...employees, newEmp];
        const nextMap = computeColorMap(nextEmployees, colorMap);
        setEmployees(nextEmployees);
        setColorMap(nextMap);
        setNameInput("");
      };

      const removeEmployee = (empId) => {
        if (readOnly) return;
        setEmployees(prev => prev.filter(e => e.id !== empId));
        setAssignments(prev => {
          const next = { ...prev };
          Object.keys(next).forEach(day => {
            const cleaned = removeEmpFromDayEntry(next[day], empId);
            const empty = ROLE_KEYS.every(rk => !cleaned.roles[rk]) && (cleaned.others || []).length === 0;
            if (empty) delete next[day];
            else next[day] = cleaned;
          });
          return next;
        });
        setVacations(prev => { const n={...prev}; delete n[empId]; return n; });
        setColorMap(prev => { const n={...prev}; delete n[empId]; return n; });
        if (highlightEmpId===empId) setHighlightEmpId(null);
      };

      const seedDemo = () => {
        const base = Date.now();
        const emps = [
          { id: base+1, name: 'Alice' },
          { id: base+2, name: 'Ben' },
          { id: base+3, name: 'Cindy' },
          { id: base+4, name: 'David' },
          { id: base+5, name: 'Emma' },
          { id: base+6, name: 'Frank' },
          { id: base+7, name: 'Gina' },
        ];

        const asg = {
          '2': addEmpToDayEntry(addEmpToDayEntry(null, emps[0].id), emps[1].id),
          '5': addEmpToDayEntry(null, emps[2].id),
          '9': (() => {
            let e = null;
            e = addEmpToDayEntry(e, emps[3].id); // S
            e = addEmpToDayEntry(e, emps[0].id); // P
            e = addEmpToDayEntry(e, emps[1].id); // F
            e = addEmpToDayEntry(e, emps[2].id); // M
            e = addEmpToDayEntry(e, emps[4].id); // others
            return e;
          })()
        };

        setEmployees(emps);
        setAssignments(asg);
        setColorMap(computeColorMap(emps, {}));
        setVacations({
          [emps[0].id]: { [dateStr(2025,8,7)]: true, [dateStr(2025,8,14)]: true },
          [emps[2].id]: { [dateStr(2025,8,5)]: true },
        });
      };

      // 拖放
      const onDragStartFromBadge = (e, empId) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ empId }));
        e.dataTransfer.effectAllowed = 'copy';
      };
      const onDragStartFromCell = (e, empId, day) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ empId, fromDay: day }));
        e.dataTransfer.effectAllowed = 'move';
      };

      const addToDay = (day, empId, preferredRole=null) => {
        setAssignments(prev => {
          const next = { ...prev };
          const curEntry = normalizeDayEntry(next[String(day)]);
          next[String(day)] = addEmpToDayEntry(curEntry, empId, preferredRole);
          return next;
        });
      };

      const removeFromDay = (day, empId) => {
        setAssignments(prev => {
          const next = { ...prev };
          const curEntry = normalizeDayEntry(next[String(day)]);
          const cleaned = removeEmpFromDayEntry(curEntry, empId);
          const empty = ROLE_KEYS.every(rk => !cleaned.roles[rk]) && (cleaned.others || []).length === 0;
          if (empty) delete next[String(day)];
          else next[String(day)] = cleaned;
          return next;
        });
      };

      const moveOrCopyToDay = (day, payload) => {
        const { empId, fromDay, toRole, toOtherIndex } = payload || {};
        if (empId == null) return;

        setAssignments(prev => {
          const next = { ...prev };

          // remove from source day if moving
          if (fromDay) {
            const srcKey = String(fromDay);
            const srcEntry = normalizeDayEntry(next[srcKey]);
            const removed = removeEmpFromDayEntry(srcEntry, empId);
            const srcEmpty = ROLE_KEYS.every(rk => !removed.roles[rk]) && (removed.others || []).length === 0;
            if (srcEmpty) delete next[srcKey];
            else next[srcKey] = removed;
          }

          // add into target day
          const dstKey = String(day);
          let dstEntry = normalizeDayEntry(next[dstKey]);

          if (toRole && ROLE_KEYS.includes(toRole)) {
            const existing = dstEntry.roles[toRole];
            if (existing && existing !== empId) {
              dstEntry = removeEmpFromDayEntry(dstEntry, empId);
              dstEntry.roles[toRole] = empId;
              dstEntry = addEmpToDayEntry(dstEntry, existing, null);
            } else {
              dstEntry = addEmpToDayEntry(dstEntry, empId, toRole);
            }
          } else if (typeof toOtherIndex === 'number') {
            // insert into others at index
            dstEntry = addEmpToDayEntry(dstEntry, empId, null);
            dstEntry = removeEmpFromDayEntry(dstEntry, empId);
            const arr = [...(dstEntry.others || [])];
            const idx = Math.max(0, Math.min(toOtherIndex, arr.length));
            arr.splice(idx, 0, empId);
            dstEntry.others = arr;
          } else {
            dstEntry = addEmpToDayEntry(dstEntry, empId, null);
          }

          next[dstKey] = dstEntry;
          return next;
        });
      };

      const totals = useMemo(() => {
        const t = Object.create(null); employees.forEach(e => t[e.id] = 0);

        Object.entries(assignments).forEach(([day, entry]) => {
          const d = Number(day);
          const h = hoursForDate(year, month, d);
          const norm = normalizeDayEntry(entry);

          const allIds = [
            ...ROLE_KEYS.map(rk => norm.roles[rk]).filter(Boolean),
            ...(norm.others || [])
          ];

          allIds.forEach(id => { if (t[id] != null) t[id] += h; });
        });

        return t;
      }, [assignments, employees, year, month]);

      const trashRef = useRef(null);
      useEffect(() => {
        const el = trashRef.current; if (!el) return;
        const onDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
        const onDrop = (e) => {
          e.preventDefault();
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (data && data.fromDay && data.empId != null) removeFromDay(data.fromDay, data.empId);
          } catch(_){}
        };
        el.addEventListener('dragover', onDragOver);
        el.addEventListener('drop', onDrop);
        return () => { el.removeEventListener('dragover', onDragOver); el.removeEventListener('drop', onDrop); };
      }, []);

      // 分享：以目前狀態組包
      const makeShareUrl = (isReadOnly) => {
        const payload = { v: 2, year, month, employees, colorMap, vacations, assignmentsByYM: { ...assignmentsByYM, [ymKey(year, month)]: assignments } };
        const u = new URL(window.location.href);
        u.hash = 's=' + encodeShare(payload);
        if (isReadOnly) u.searchParams.set('readOnly', '1'); else u.searchParams.delete('readOnly');
        return u.toString();
      };
      const copyShare = async (isReadOnly) => {
        const url = makeShareUrl(isReadOnly);
        await navigator.clipboard.writeText(url);
        setSaved(true); setTimeout(()=>setSaved(false), 1500);
      };

      return (
        <div className="h-full flex flex-col">
          <header className="border-b bg-white">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
              <h1 className="text-lg font-semibold text-slate-800">排班工具（週日為第一天）</h1>
              <span className="text-xs text-slate-500">週一到週五 7 小時，週末 6 小時</span>
              {readOnly && (<span className="ml-auto text-xs px-2 py-1 rounded bg-amber-100 text-amber-700">唯讀檢視</span>)}
            </div>
          </header>

          <main className="flex-1 max-w-7xl mx-auto w-full px-4 py-4 grid grid-cols-12 gap-4">
            <aside className="col-span-12 lg:col-span-4 xl:col-span-3 flex flex-col gap-4">
              <section className="bg-white border rounded-2xl p-4 shadow-sm">
                <div className="flex items-center justify-between"><div className="font-medium text-slate-700">員工名單</div></div>
                {!readOnly && (
                  <div className="mt-3 flex gap-2">
                    <input value={nameInput} onChange={(e)=>setNameInput(e.target.value)} placeholder="輸入員工名字" className="flex-1 border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <button onClick={addEmployee} className="px-3 py-2 text-sm rounded-xl bg-blue-600 text-white hover:bg-blue-700">加入</button>
                  </div>
                )}
                <div className="mt-3 max-h-56 overflow-auto pr-1 scrollbar-thin">
                  {employees.length === 0 && (
                    <div className="flex items-center justify-between text-sm text-slate-500">
                      <span>尚無員工，請新增或建立示範資料。</span>
                      {!readOnly && <button onClick={seedDemo} className="text-blue-600 hover:underline">建立示範資料</button>}
                    </div>
                  )}
                  <ul className="flex flex-wrap gap-2">
                    {employees.map(emp => {
                      const color = getEmpColor(emp.id);
                      const hl = highlightEmpId===emp.id ? 'ring-2 ring-blue-300' : '';
                      return (
                        <li key={emp.id} className={`shrink-0 flex items-center gap-2 px-2 py-1 rounded-2xl border text-sm ${color} ${hl}`}
                            draggable={!readOnly}
                            onDragStart={(e)=>onDragStartFromBadge(e, emp.id)}
                        >
                          <button
                            className="text-slate-800 hover:underline flex items-center gap-1 whitespace-nowrap"
                            onClick={()=> setHighlightEmpId(highlightEmpId===emp.id? null: emp.id)}
                            title={emp.name}
                          >
                            <span className="font-semibold sm:hidden">{abbr(emp.name)}</span>
                            <span className="hidden sm:inline truncate max-w-[10rem]">{emp.name}</span>
                          </button>
                          {!readOnly && (
                            <button
                              className="ml-1 text-[11px] px-2 py-0.5 rounded border text-rose-700 border-rose-300 hover:bg-rose-50"
                              onClick={(e)=> { setVacEditEmp({ emp, anchor: { x: e.clientX, y: e.clientY } }); }}
                              title="設定休假日"
                            >假</button>
                          )}
                          {!readOnly && (
                            <button className="ml-auto text-xs text-slate-500 hover:text-red-500" onClick={()=>removeEmployee(emp.id)} title="刪除員工">✕</button>
                          )}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              </section>

              {!readOnly && (
                <section className="bg-white border rounded-2xl p-4 shadow-sm">
                  <div className="font-medium text-slate-700">{monthLabel(year, month)} 本月總時數</div>
                  <div className="mt-3 max-h-64 overflow-auto pr-1 scrollbar-thin">
                    {employees.length === 0 ? (
                      <div className="text-sm text-slate-400">尚無資料</div>
                    ) : (
                      <table className="w-full text-sm">
                        <thead className="sticky top-0 bg-white">
                          <tr className="text-slate-400">
                            <th className="text-left font-normal py-1">員工</th>
                            <th className="text-right font-normal py-1">時數</th>
                          </tr>
                        </thead>
                        <tbody>
                          {employees.map(emp => (
                            <tr key={emp.id} className={"border-t " + (highlightEmpId===emp.id? 'bg-blue-50':'') }>
                              <td className="py-1">
                                <div className="flex items-center">
                                  <button className="text-slate-700 hover:underline flex items-center gap-1 whitespace-nowrap" onClick={()=> setHighlightEmpId(highlightEmpId===emp.id? null: emp.id)}>
                                    <span className="font-semibold sm:hidden">{abbr(emp.name)}</span>
                                    <span className="hidden sm:inline truncate max-w-[10rem]">{emp.name}</span>
                                  </button>
                                  {!readOnly && (
                                    <button
                                      className="ml-2 text-[11px] px-2 py-0.5 rounded border text-rose-700 border-rose-300 hover:bg-rose-50"
                                      onClick={(e)=> { setVacEditEmp({ emp, anchor: { x: e.clientX, y: e.clientY } }); }}
                                      title="設定休假日"
                                    >假</button>
                                  )}
                                </div>
                              </td>
                              <td className="py-1 text-right tabular-nums">{totals[emp.id] || 0}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </section>
              )}

              {!readOnly && (
                <section ref={trashRef} className="bg-white border rounded-2xl p-4 shadow-sm">
                  <div className="font-medium text-slate-700">刪除區</div>
                  <p className="mt-2 text-sm text-slate-500">將日期中的名牌拖曳到此處可刪除。</p>
                </section>
              )}

              <section className="bg-white border rounded-2xl p-4 shadow-sm">
                <div className="font-medium text-slate-700">雲端儲存與分享</div>
                <div className="mt-3 flex flex-col gap-2">
                  {!readOnly && (
                    <button onClick={saveRemote} className="px-3 py-2 rounded-2xl text-sm bg-emerald-600 text-white hover:bg-emerald-700">儲存到雲端（Netlify）</button>
                  )}
                  <div className="flex gap-2">
                    <button onClick={()=>copyShare(true)} className="flex-1 px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50">複製唯讀分享連結</button>
                    {!readOnly && (
                      <button onClick={()=>copyShare(false)} className="flex-1 px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50" title="允許他人共同編輯">複製可編輯連結</button>
                    )}
                  </div>
                  {saved && <div className="text-xs text-emerald-700">已完成</div>}
                </div>
              </section>

              {vacEditEmp && !readOnly && (
                <VacationPopover
                  emp={vacEditEmp.emp}
                  anchor={vacEditEmp.anchor}
                  baseYear={year}
                  baseMonth={month}
                  isVacation={isVacation}
                  toggleVacation={toggleVacation}
                  onClose={()=>setVacEditEmp(null)}
                />
              )}
            </aside>

            <section className="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col gap-4">
              <div className="bg-white border rounded-2xl p-3 shadow-sm flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <button onClick={()=>{ let y=year, m=month-1; if(m<0){m=11;y--; } setYear(y); setMonth(m); setHighlightEmpId(null); }} className="px-2 py-1 rounded-lg border bg-white hover:bg-slate-50" title="上一個月">◀</button>
                  <div className="font-medium text-slate-800">{monthLabel(year, month)}</div>
                  <button onClick={()=>{ let y=year, m=month+1; if(m>11){m=0;y++; } setYear(y); setMonth(m); setHighlightEmpId(null); }} className="px-2 py-1 rounded-lg border bg-white hover:bg-slate-50" title="下一個月">▶</button>
                </div>
                {!readOnly && (
                  <button onClick={()=>{ if (confirm('清除本月所有排班？')) setAssignments({}); }} className="px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50">清空本月排班</button>
                )}
              </div>

              <div className="bg-white border rounded-2xl p-4 shadow-sm">
                <ScaleBox maxScale={1}>
                  <div className="w-[980px]">
                    <div className="grid grid-cols-7 gap-2 text-center text-slate-500 text-sm mb-2">
                      {['週日','週一','週二','週三','週四','週五','週六'].map((w) => (<div key={w} className="font-medium">{w}</div>))}
                    </div>
                    <div className="grid grid-cols-7 gap-2 auto-rows-fr">
                      {weeks.flat().map((c, idx) => c.type === 'pad' ? (
                        <div key={idx} className="min-h-36 rounded-2xl bg-slate-50 border border-dashed"></div>
                      ) : (
                        <CalendarCell
                          key={idx}
                          d={c.d}
                          year={year}
                          month={month}
                          readOnly={readOnly}
                          empList={employees}
                          dayEntry={assignments[String(c.d)]}
                          highlightEmpId={highlightEmpId}
                          getEmpColor={getEmpColor}
                          onDropPayload={moveOrCopyToDay}
                          onAdd={(empId, role)=>addToDay(c.d, empId, role)}
                          onRemove={(empId)=>removeFromDay(c.d, empId)}
                          onDragStartFromCell={onDragStartFromCell}
                          isVacation={isVacation}
                        />
                      ))}
                    </div>
                  </div>
                </ScaleBox>
              </div>
            </section>
          </main>
        </div>
      );
    }

    function CalendarCell({
      d, year, month, empList, dayEntry,
      readOnly, highlightEmpId, getEmpColor,
      onDropPayload, onAdd, onRemove, onDragStartFromCell,
      isVacation
    }) {
      const ref = useRef(null);
      const h = hoursForDate(year, month, d);
      const norm = useMemo(() => normalizeDayEntry(dayEntry), [dayEntry]);

      const roleAssignedIds = ROLE_KEYS.map(rk => norm.roles[rk]).filter(Boolean);
      const assignedAll = [...roleAssignedIds, ...(norm.others || [])];

      const isHL = highlightEmpId != null && assignedAll.includes(highlightEmpId);
      const isVacHL = highlightEmpId != null && isVacation(highlightEmpId, year, month, d);

      const allowDrop = (e) => {
        if (readOnly) return false;
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          const empId = data?.empId;
          if (empId != null && isVacation(empId, year, month, d)) return false;
        } catch {}
        return true;
      };

      // Drop on whole cell: default add, auto fill S->P->F->M then others
      useEffect(() => {
        const el = ref.current; if (!el) return;

        const onDragOver = (e) => {
          if (!allowDrop(e)) { e.dataTransfer.dropEffect = 'none'; return; }
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
        };

        const onDrop = (e) => {
          if (!allowDrop(e)) return;
          e.preventDefault();
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const empId = data?.empId;
            if (empId == null) return;
            if (data.fromDay) onDropPayload(d, { ...data });
            else onAdd(empId, null);
          } catch {}
        };

        el.addEventListener('dragover', onDragOver);
        el.addEventListener('drop', onDrop);
        return () => { el.removeEventListener('dragover', onDragOver); el.removeEventListener('drop', onDrop); };
      }, [d, readOnly, year, month, isVacation]);

      const renderEmpChip = (empId, extraClasses="") => {
        const emp = empList.find(e => e.id === empId);
        if (!emp) return null;

        const isThisHL = highlightEmpId === empId;
        const color = getEmpColor(empId);
        const ring = isThisHL ? 'ring-2 ring-blue-300' : '';
        const vacToday = isVacation(empId, year, month, d);

        return (
          <div
            className={"group flex items-center gap-1 text-[11px] leading-tight px-2 py-0.5 rounded-md border " + color + ' ' + ring + (vacToday ? ' border-rose-500' : '') + ' ' + extraClasses}
            draggable={!readOnly}
            onDragStart={(e)=>onDragStartFromCell(e, empId, d)}
            title={emp.name}
          >
            <span className="font-semibold sm:hidden">{(emp.name || '').slice(0,3).toUpperCase()}</span>
            <span className="hidden sm:inline truncate">{emp.name}</span>
            {vacToday && <span className="ml-1 text-[10px] text-rose-700">休</span>}
            {!readOnly && (
              <button className="ml-auto opacity-0 group-hover:opacity-100 transition text-slate-500 hover:text-red-500"
                onClick={()=>onRemove(empId)} title="移除">✕</button>
            )}
          </div>
        );
      };

      const onDropToRole = (rk) => (e) => {
        if (!allowDrop(e)) return;
        e.preventDefault();
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          const empId = data?.empId;
          if (empId == null) return;
          onDropPayload(d, { ...data, toRole: rk });
        } catch {}
      };

      const onDropToOthersAt = (index) => (e) => {
        if (!allowDrop(e)) return;
        e.preventDefault();
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          const empId = data?.empId;
          if (empId == null) return;
          onDropPayload(d, { ...data, toOtherIndex: index });
        } catch {}
      };

      const onDragStartOthersItem = (e, empId, idx) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ empId, fromDay: d, fromOtherIndex: idx }));
        e.dataTransfer.effectAllowed = 'move';
      };

      return (
        <div ref={ref}
          className={("min-h-36 rounded-2xl border p-2 flex flex-col gap-2 bg-white ") +
            (isHL? ' ring-4 ring-blue-400 border-blue-400' : ' border-slate-200') +
            (isVacHL ? ' outline outline-2 outline-rose-400' : '')
          }
          title={isWeekend(year, month, d) ? '假日 6 小時' : '平日 7 小時'}
        >
          <div className="flex items-center justify-between text-xs text-slate-500">
            <span className="font-medium text-slate-700">{d}</span>
            {!readOnly && (<span className="px-1 py-0.5 rounded bg-slate-100">{h} 小時</span>)}
          </div>

          {/* Roles S/P/F/M */}
          <div className="grid grid-cols-2 gap-1">
            {ROLE_KEYS.map(rk => {
              const empId = norm.roles[rk];
              return (
                <div
                  key={rk}
                  className="rounded-lg border border-slate-200 p-1"
                  onDragOver={(e)=>{ if (allowDrop(e)) { e.preventDefault(); e.dataTransfer.dropEffect='move'; } }}
                  onDrop={onDropToRole(rk)}
                  title="可拖曳到此設定職位"
                >
                  <div className="flex items-center justify-between">
                    <div className="text-[11px] text-slate-500 font-medium">{rk}</div>
                    {!readOnly && empId && (
                      <button className="text-[11px] text-slate-400 hover:text-red-500" onClick={()=>onRemove(empId)} title="清空此職位">✕</button>
                    )}
                  </div>
                  <div className="mt-1 min-h-[18px]">
                    {empId ? renderEmpChip(empId) : (!readOnly ? <div className="text-[11px] text-slate-300 select-none">拖到這裡</div> : <div className="h-4"></div>)}
                  </div>
                </div>
              );
            })}
          </div>

          {/* Others list with sortable order */}
          <div className="rounded-lg border border-slate-200 p-1">
            <div className="text-[11px] text-slate-500 font-medium">其他</div>

            {(norm.others || []).length === 0 ? (
              !readOnly ? <div className="text-[11px] text-slate-300 select-none mt-1">可拖到此加入，並可拖曳排序</div> : <div className="h-4"></div>
            ) : (
              <ul className="mt-1 flex flex-col gap-1">
                {(norm.others || []).map((empId, idx) => (
                  <li key={empId}
                    className="rounded-md"
                    onDragOver={(e)=>{ if (allowDrop(e)) { e.preventDefault(); e.dataTransfer.dropEffect='move'; } }}
                    onDrop={onDropToOthersAt(idx)}
                    title="拖到某一列可插入到該位置"
                  >
                    <div
                      className="w-full"
                      draggable={!readOnly}
                      onDragStart={(e)=>onDragStartOthersItem(e, empId, idx)}
                    >
                      {renderEmpChip(empId)}
                    </div>
                  </li>
                ))}

                {/* drop to end */}
                <li
                  className="h-5"
                  onDragOver={(e)=>{ if (allowDrop(e)) { e.preventDefault(); e.dataTransfer.dropEffect='move'; } }}
                  onDrop={onDropToOthersAt((norm.others || []).length)}
                  title="拖到最底可放到最後"
                />
              </ul>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
