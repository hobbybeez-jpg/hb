<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobby Bee 排班工具（正式版：週日為每週第一天）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,
    body,
    #root {
      height: 100%;
    }

    .scrollbar-thin::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 9999px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }

    .calendar-inner {
      display: inline-block;
      transform-origin: top left;
    }
  </style>
</head>

<body class="bg-slate-50">
  <!-- safelist：確保 Tailwind 生成以下顏色類別供 JS 動態套用（強對比組合） -->
  <div class="hidden" aria-hidden="true">
    <span class="bg-red-200 border-red-700 text-red-900"></span>
    <span class="bg-orange-200 border-orange-700 text-orange-900"></span>
    <span class="bg-amber-200 border-amber-700 text-amber-900"></span>
    <span class="bg-emerald-200 border-emerald-700 text-emerald-900"></span>
    <span class="bg-teal-200 border-teal-700 text-teal-900"></span>
    <span class="bg-blue-200 border-blue-700 text-blue-900"></span>
    <span class="bg-violet-200 border-violet-700 text-violet-900"></span>
    <span class="bg-rose-200 border-rose-700 text-rose-900"></span>
    <span class="bg-cyan-200 border-cyan-700 text-cyan-900"></span>
    <span class="bg-indigo-200 border-indigo-700 text-indigo-900"></span>
    <span class="bg-lime-200 border-lime-700 text-lime-900"></span>
    <span class="bg-fuchsia-200 border-fuchsia-700 text-fuchsia-900"></span>
    <span class="bg-pink-200 border-pink-700 text-pink-900"></span>
    <span class="bg-purple-200 border-purple-700 text-purple-900"></span>
    <span class="bg-sky-200 border-sky-700 text-sky-900"></span>
    <span class="bg-slate-200 border-slate-700 text-slate-900"></span>
    <span class="bg-stone-200 border-stone-700 text-stone-900"></span>
    <span class="bg-green-200 border-green-700 text-green-900"></span>
  </div>

  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState, useLayoutEffect } = React;

    // === 職務欄位定義 ===
    const POSITIONS = ['S', 'P', 'F', 'M', 'blank']; // blank 可排複數員工

    // === Utils（週日為每週第一天） ===
    const ymKey = (y, m) => `${y}-${String(m + 1).padStart(2, '0')}`; // m:0-11
    const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
    const getDOW = (y, m, d) => new Date(y, m, d).getDay(); // 0..6 Sun..Sat
    const isWeekend = (y, m, d) => { const dow = getDOW(y, m, d); return dow === 0 || dow === 6; };
    const hoursForDate = (y, m, d) => (isWeekend(y, m, d) ? 6 : 7);
    const dateStr = (y, m, d) => `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

    // Legacy share encoding (for backward compatibility)
    const encodeShareLegacy = (obj) => btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    const decodeShareLegacy = (str) => JSON.parse(decodeURIComponent(escape(atob(str))));

    // 將舊版 assignments 格式轉為新版（支援職務欄）
    const migrateAssignments = (oldAssign) => {
      if (!oldAssign || typeof oldAssign !== 'object') return {};
      const newAssign = {};
      Object.entries(oldAssign).forEach(([day, val]) => {
        if (Array.isArray(val)) {
          // 舊版格式：[empId, empId, ...]
          newAssign[day] = { S: null, P: null, F: null, M: null, blank: [...val] };
        } else if (typeof val === 'object' && val !== null) {
          // 新版格式，直接使用
          newAssign[day] = val;
        }
      });
      return newAssign;
    };

    // 取得某日某職務的員工列表
    const getPositionEmps = (dayAssign, pos) => {
      if (!dayAssign) return [];
      if (pos === 'blank') return dayAssign.blank || [];
      return dayAssign[pos] ? [dayAssign[pos]] : [];
    };

    const DISTINCT_KEYS = ['red', 'orange', 'amber', 'emerald', 'teal', 'blue', 'violet'];
    const EXTENDED_KEYS = [...DISTINCT_KEYS, 'rose', 'cyan', 'indigo', 'lime', 'fuchsia', 'pink', 'purple', 'sky', 'slate', 'stone', 'green'];
    const colorClassForKey = (key) => `bg-${key}-200 border-${key}-700 text-${key}-900`;

    function hashStr(s) { let h = 2166136261 >>> 0; for (let i = 0; i < s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); } return h >>> 0; }
    function computeColorMap(employees, existingMap = {}) {
      const ids = new Set(employees.map(e => e.id));
      const map = {}; Object.keys(existingMap || {}).forEach(id => { if (ids.has(+id) || ids.has(id)) map[id] = existingMap[id]; });
      const used = new Set(Object.values(map));
      const unassigned = employees.filter(e => map[e.id] == null).slice().sort((a, b) => {
        const ha = hashStr(String(a.name || '').toLowerCase());
        const hb = hashStr(String(b.name || '').toLowerCase());
        return ha - hb;
      });
      const pickKey = () => {
        for (const k of DISTINCT_KEYS) { if (!used.has(k)) { used.add(k); return k; } }
        for (const k of EXTENDED_KEYS) { if (!used.has(k)) { used.add(k); return k; } }
        const arr = EXTENDED_KEYS; return arr[(used.size) % arr.length];
      };
      unassigned.forEach(e => { map[e.id] = pickKey(); });
      return map;
    }

    function buildMonthMatrix(year, month) {
      const total = daysInMonth(year, month);
      const firstDow = new Date(year, month, 1).getDay(); // 0..6 Sun..Sat
      const leading = firstDow; // 週日置前
      const slots = leading + total;
      const weekCount = Math.ceil(slots / 7);
      const weeks = Array.from({ length: weekCount }, () => Array(7).fill(null).map(() => ({ type: 'pad' })));
      let day = 1;
      for (let w = 0; w < weekCount; w++) {
        for (let dow = 0; dow < 7; dow++) {
          const index = w * 7 + dow;
          if (index >= leading && day <= total) {
            weeks[w][dow] = { type: 'day', d: day };
            day++;
          }
        }
      }
      return { weeks, weekCount };
    }

    function ScaleBox({ children, maxScale = 1 }) {
      const wrapRef = useRef(null);
      const innerRef = useRef(null);
      const [height, setHeight] = useState(null);
      useLayoutEffect(() => {
        const wrap = wrapRef.current; const inner = innerRef.current; if (!wrap || !inner) return;
        const update = () => {
          inner.style.transform = 'scale(1)';
          const iw = inner.scrollWidth || inner.offsetWidth;
          const ih = inner.scrollHeight || inner.offsetHeight;
          const ww = wrap.clientWidth;
          const s = iw ? Math.min(ww / iw, maxScale) : 1;
          inner.style.transform = `scale(${s})`;
          setHeight(ih * s);
        };
        const ro = new ResizeObserver(update);
        ro.observe(wrap); ro.observe(inner);
        window.addEventListener('resize', update);
        update();
        return () => { ro.disconnect(); window.removeEventListener('resize', update); };
      }, []);
      return (
        <div ref={wrapRef} className="w-full" style={{ position: 'relative', height: height ? `${height}px` : 'auto' }}>
          <div ref={innerRef} className="calendar-inner">{children}</div>
        </div>
      );
    }

    // ===== Netlify Blobs API（Functions 代理） =====
    const REMOTE_KEY = 'hb-default';
    const API_BASE = '/.netlify/functions/schedule';

    async function loadRemoteAll() {
      try { const res = await fetch(`${API_BASE}?key=${encodeURIComponent(REMOTE_KEY)}`); if (!res.ok) return null; return await res.json(); }
      catch { return null; }
    }
    async function saveRemoteAll(payload) {
      const res = await fetch(`${API_BASE}?key=${encodeURIComponent(REMOTE_KEY)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok && res.status !== 204) throw new Error('儲存失敗');
    }

    // ===== Portal：休假彈窗置頂 =====
    function Portal({ children }) {
      const [node] = useState(() => document.createElement('div'));
      useEffect(() => { document.body.appendChild(node); return () => { document.body.removeChild(node); }; }, [node]);
      return ReactDOM.createPortal(children, node);
    }

    // ===== 放大版休假 Popover（週日置前） =====
    function VacationPopover({ emp, anchor, baseYear, baseMonth, onClose, isVacation, toggleVacation }) {
      const [off, setOff] = useState(0);
      const cur = new Date(baseYear, baseMonth + off, 1);
      const y = cur.getFullYear();
      const m = cur.getMonth();

      const [pos, setPos] = useState({ left: 0, top: 0 });
      useEffect(() => {
        const PADDING = 12;
        const width = Math.min(window.innerWidth * 0.92, 560);
        const height = 380;
        let left = anchor.x; let top = anchor.y;
        if (left + width + PADDING > window.innerWidth) left = window.innerWidth - width - PADDING;
        if (top + height + PADDING > window.innerHeight) top = window.innerHeight - height - PADDING;
        if (left < PADDING) left = PADDING; if (top < PADDING) top = PADDING;
        setPos({ left, top });
      }, [anchor]);

      useEffect(() => {
        const onKey = (e) => { if (e.key === 'Escape') onClose(); };
        const onScroll = () => onClose();
        window.addEventListener('keydown', onKey);
        window.addEventListener('scroll', onScroll, { passive: true });
        return () => { window.removeEventListener('keydown', onKey); window.removeEventListener('scroll', onScroll); };
      }, [onClose]);

      const { weeks } = useMemo(() => buildMonthMatrix(y, m), [y, m]);

      return (
        <Portal>
          <div className="fixed inset-0 z-[99998]">
            <div className="absolute inset-0" onClick={onClose}></div>
            <div className="absolute z-[99999] p-4 bg-white border rounded-2xl shadow-2xl"
              style={{ left: pos.left, top: pos.top, width: Math.min(window.innerWidth * 0.92, 560) }}>
              <div className="flex items-center justify-between mb-3">
                <div className="text-base font-semibold text-slate-800">{emp.name} 的休假日</div>
                <div className="flex items-center gap-1">
                  <button className="px-2 py-1 rounded-lg border hover:bg-slate-50" title="上一月" onClick={() => setOff(off - 1)}>◀</button>
                  <div className="px-2 text-slate-700 font-medium">{y} 年 {String(m + 1).padStart(2, '0')} 月</div>
                  <button className="px-2 py-1 rounded-lg border hover:bg-slate-50" title="下一月" onClick={() => setOff(off + 1)}>▶</button>
                  <button className="ml-2 px-2 py-1 rounded-lg border text-slate-500 hover:text-slate-700 hover:bg-slate-50" onClick={onClose} title="關閉">✕</button>
                </div>
              </div>
              <div className="grid grid-cols-7 gap-2 text-center text-sm text-slate-500 mb-2">
                {['日', '一', '二', '三', '四', '五', '六'].map((w) => <div key={w} className="font-medium">{w}</div>)}
              </div>
              <div className="grid grid-cols-7 gap-2">
                {weeks.flat().map((c, idx) => c.type === 'pad' ? (
                  <div key={idx} className="h-10"></div>
                ) : (
                  <button key={idx}
                    onClick={() => toggleVacation(emp.id, y, m, c.d)}
                    className={
                      "h-10 w-10 md:h-12 md:w-12 rounded-lg text-base md:text-lg leading-none flex items-center justify-center select-none transition " +
                      (isVacation(emp.id, y, m, c.d)
                        ? "bg-rose-100 border border-rose-500 text-rose-700 shadow-[inset_0_0_0_1px_rgba(244,63,94,0.2)]"
                        : "border border-slate-200 hover:bg-slate-50")}
                    title="點擊切換休假"
                  >{c.d}</button>
                ))}
              </div>
              <div className="mt-3 text-xs text-slate-500 flex items-center justify-between">
                <span>提示：紅色為休假，不可排班。按 ESC 或背景關閉。</span>
                <button className="px-2 py-1 rounded border hover:bg-slate-50" onClick={() => setOff(0)}>回到本月</button>
              </div>
            </div>
          </div>
        </Portal>
      );
    }

    function App() {
      // 預設自動跳到當月份
      const today = new Date();
      const [year, setYear] = useState(today.getFullYear());
      const [month, setMonth] = useState(today.getMonth()); // 0-11

      const [nameInput, setNameInput] = useState("");
      const [employees, setEmployees] = useState([]);
      const [assignments, setAssignments] = useState({}); // 當月
      const [assignmentsByYM, setAssignmentsByYM] = useState({}); // 全部月份
      const [colorMap, setColorMap] = useState({});
      const [vacations, setVacations] = useState({}); // { [empId]: { 'YYYY-MM-DD': true } }

      const [highlightEmpId, setHighlightEmpId] = useState(null);
      const [readOnly, setReadOnly] = useState(false);
      const [saved, setSaved] = useState(false);

      const [vacEditEmp, setVacEditEmp] = useState(null); // {emp, anchor:{x,y}}

      // 解析唯讀/分享（支援短碼或舊版 hash 格式）
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        setReadOnly(params.get('readOnly') === '1');

        // 優先檢查短碼
        const code = params.get('code');
        if (code) {
          (async () => {
            try {
              const res = await fetch(`${API_BASE}?code=${encodeURIComponent(code)}`);
              if (res.ok) {
                const payload = await res.json();
                if (payload && payload.employees) {
                  setYear(payload.year || new Date().getFullYear());
                  setMonth(payload.month ?? new Date().getMonth());
                  setEmployees(payload.employees || []);
                  if (payload.assignmentsByYM) {
                    const migratedByYM = {};
                    Object.entries(payload.assignmentsByYM).forEach(([ym, asg]) => {
                      migratedByYM[ym] = migrateAssignments(asg);
                    });
                    setAssignmentsByYM(migratedByYM);
                    setAssignments(migratedByYM[ymKey(payload.year, payload.month)] || {});
                  }
                  setColorMap(payload.colorMap || {});
                  setVacations(payload.vacations || {});
                  setReadOnly(true);
                }
              }
            } catch (e) { console.warn('短碼解析失敗', e); }
          })();
          return;
        }

        // 向後相容：舊版 hash 格式
        const hash = window.location.hash || '';
        if (hash.startsWith('#s=')) {
          try {
            const payload = decodeShareLegacy(hash.slice(3));
            if (payload && (payload.v === 1 || payload.v === 2 || payload.v === 3)) {
              setYear(payload.year); setMonth(payload.month);
              setEmployees(payload.employees || []);
              if (payload.assignmentsByYM) {
                const migratedByYM = {};
                Object.entries(payload.assignmentsByYM).forEach(([ym, asg]) => {
                  migratedByYM[ym] = migrateAssignments(asg);
                });
                setAssignmentsByYM(migratedByYM);
                setAssignments(migratedByYM[ymKey(payload.year, payload.month)] || {});
              } else {
                setAssignments(migrateAssignments(payload.assignments || {}));
              }
              setColorMap(payload.colorMap || {});
              setVacations(payload.vacations || {});
              setReadOnly(true);
            }
          } catch (e) { console.warn('共享連結解析失敗', e); }
        }
      }, []);

      // 啟動時嘗試載入雲端資料（含資料遷移）
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('code')) return; // 短碼模式不載入雲端
        (async () => {
          const remote = await loadRemoteAll();
          if (remote) {
            setEmployees(remote.employees || []);
            setColorMap(remote.colorMap || {});
            setVacations(remote.vacations || {});
            const byYM = remote.assignmentsByYM || {};
            const migratedByYM = {};
            Object.entries(byYM).forEach(([ym, asg]) => {
              migratedByYM[ym] = migrateAssignments(asg);
            });
            setAssignmentsByYM(migratedByYM);
            setAssignments(migratedByYM[ymKey(year, month)] || {});
          }
        })();
      }, []);

      // 員工顏色保持穩定
      useEffect(() => {
        const next = computeColorMap(employees, colorMap);
        if (JSON.stringify(next) !== JSON.stringify(colorMap)) setColorMap(next);
      }, [employees]);

      // 切換月份時載入當月資料（來自 assignmentsByYM）
      useEffect(() => {
        setAssignments(assignmentsByYM[ymKey(year, month)] || {});
      }, [year, month, assignmentsByYM]);

      const { weeks } = useMemo(() => buildMonthMatrix(year, month), [year, month]);

      const isVacation = (empId, y, m, d) => !!vacations?.[empId]?.[dateStr(y, m, d)];
      const toggleVacation = (empId, y, m, d) => {
        setVacations(prev => {
          const ds = dateStr(y, m, d);
          const cur = { ...(prev[empId] || {}) };
          if (cur[ds]) delete cur[ds]; else cur[ds] = true;
          return { ...prev, [empId]: cur };
        });
      };

      const saveRemote = async () => {
        const ym = ymKey(year, month);
        const merged = { ...assignmentsByYM, [ym]: assignments };
        const payload = { employees, colorMap, vacations, assignmentsByYM: merged };
        await saveRemoteAll(payload);
        setAssignmentsByYM(merged);
        setSaved(true); setTimeout(() => setSaved(false), 1500);
      };

      const monthLabel = (y, m) => `${y} 年 ${String(m + 1).padStart(2, '0')} 月`;
      const abbr = (name) => (name || '').trim().slice(0, 3).toUpperCase();

      const getEmpColor = (empId) => {
        const key = colorMap[empId];
        return colorClassForKey(key || 'emerald');
      };

      const addEmployee = () => {
        if (readOnly) return;
        const name = nameInput.trim(); if (!name) return;
        const id = Date.now() + Math.random();
        const newEmp = { id, name };
        const nextEmployees = [...employees, newEmp];
        const nextMap = computeColorMap(nextEmployees, colorMap);
        setEmployees(nextEmployees);
        setColorMap(nextMap);
        setNameInput("");
      };

      const removeEmployee = (empId) => {
        if (readOnly) return;
        setEmployees(prev => prev.filter(e => e.id !== empId));
        setAssignments(prev => {
          const next = { ...prev };
          Object.keys(next).forEach(day => {
            const dayAsg = next[day];
            if (!dayAsg) return;
            // 清除各職務欄中的員工
            const updated = { ...dayAsg };
            POSITIONS.forEach(pos => {
              if (pos === 'blank') {
                updated.blank = (updated.blank || []).filter(id => id !== empId);
              } else if (updated[pos] === empId) {
                updated[pos] = null;
              }
            });
            // 檢查是否還有員工
            const hasAny = POSITIONS.some(p => p === 'blank' ? updated.blank?.length > 0 : updated[p] != null);
            if (hasAny) next[day] = updated; else delete next[day];
          });
          return next;
        });
        setVacations(prev => { const n = { ...prev }; delete n[empId]; return n; });
        setColorMap(prev => { const n = { ...prev }; delete n[empId]; return n; });
        if (highlightEmpId === empId) setHighlightEmpId(null);
      };

      const seedDemo = () => {
        const base = Date.now();
        const emps = [
          { id: base + 1, name: 'Alice' },
          { id: base + 2, name: 'Ben' },
          { id: base + 3, name: 'Cindy' },
          { id: base + 4, name: 'David' },
          { id: base + 5, name: 'Emma' },
          { id: base + 6, name: 'Frank' },
          { id: base + 7, name: 'Gina' },
        ];
        // 新版資料結構：每日分職務欄
        const asg = {
          '2': { S: emps[0].id, P: emps[1].id, F: null, M: null, blank: [] },
          '5': { S: emps[2].id, P: null, F: null, M: null, blank: [] },
          '9': { S: emps[3].id, P: emps[0].id, F: emps[1].id, M: null, blank: [emps[2].id] },
        };
        setEmployees(emps);
        setAssignments(asg);
        setColorMap(computeColorMap(emps, {}));
        setVacations({
          [emps[0].id]: { [dateStr(2025, 8, 7)]: true, [dateStr(2025, 8, 14)]: true },
          [emps[2].id]: { [dateStr(2025, 8, 5)]: true },
        });
      };

      // 拖放（支援職務欄）
      const onDragStartFromBadge = (e, empId) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ empId }));
        e.dataTransfer.effectAllowed = 'copy';
      };
      const onDragStartFromCell = (e, empId, day, pos) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ empId, fromDay: day, fromPos: pos }));
        e.dataTransfer.effectAllowed = 'move';
      };

      // 新增員工到某日某職務
      const addToPosition = (day, pos, empId) => {
        setAssignments(prev => {
          const dayKey = String(day);
          const dayAsg = prev[dayKey] || { S: null, P: null, F: null, M: null, blank: [] };
          const updated = { ...dayAsg };
          if (pos === 'blank') {
            if (!updated.blank) updated.blank = [];
            if (!updated.blank.includes(empId)) updated.blank = [...updated.blank, empId];
          } else {
            updated[pos] = empId;
          }
          return { ...prev, [dayKey]: updated };
        });
      };

      // 從某日某職務移除員工
      const removeFromPosition = (day, pos, empId) => {
        setAssignments(prev => {
          const dayKey = String(day);
          const dayAsg = prev[dayKey];
          if (!dayAsg) return prev;
          const updated = { ...dayAsg };
          if (pos === 'blank') {
            updated.blank = (updated.blank || []).filter(id => id !== empId);
          } else if (updated[pos] === empId) {
            updated[pos] = null;
          }
          const hasAny = POSITIONS.some(p => p === 'blank' ? updated.blank?.length > 0 : updated[p] != null);
          if (hasAny) return { ...prev, [dayKey]: updated };
          const next = { ...prev }; delete next[dayKey]; return next;
        });
      };

      // 拖放處理（支援同日職務間移動/替換）
      const handleDrop = (day, pos, payload) => {
        const { empId, fromDay, fromPos } = payload;
        const sameDay = fromDay && Number(fromDay) === Number(day);
        const samePos = fromPos === pos;
        if (sameDay && samePos) return; // 同位置不處理

        setAssignments(prev => {
          const next = { ...prev };
          const dayKey = String(day);

          // 同日替換：特殊處理
          if (sameDay) {
            const dayAsg = next[dayKey] || { S: null, P: null, F: null, M: null, blank: [] };
            const updated = { ...dayAsg, blank: [...(dayAsg.blank || [])] };

            // 取得目標位置和來源位置的員工
            let targetEmpId = null;
            if (pos !== 'blank') {
              targetEmpId = updated[pos];
            }

            // 從來源位置移除
            if (fromPos === 'blank') {
              updated.blank = updated.blank.filter(id => id !== empId);
            } else {
              // 把目標位置的員工放到來源位置（交換）
              updated[fromPos] = targetEmpId;
            }

            // 添加到目標位置
            if (pos === 'blank') {
              if (!updated.blank.includes(empId)) updated.blank.push(empId);
            } else {
              updated[pos] = empId;
            }

            next[dayKey] = updated;
            return next;
          }

          // 跨日移動
          const dayAsg = next[dayKey] || { S: null, P: null, F: null, M: null, blank: [] };
          const updated = { ...dayAsg, blank: [...(dayAsg.blank || [])] };

          // 目標位置現有員工
          let existingEmpId = null;
          if (pos !== 'blank') {
            existingEmpId = updated[pos];
          }

          // 從來源位置移除
          if (fromDay) {
            const fromDayKey = String(fromDay);
            const fromDayAsg = next[fromDayKey];
            if (fromDayAsg) {
              const fromUpdated = { ...fromDayAsg, blank: [...(fromDayAsg.blank || [])] };
              if (fromPos === 'blank') {
                fromUpdated.blank = fromUpdated.blank.filter(id => id !== empId);
              } else {
                fromUpdated[fromPos] = null;
              }
              const hasAny = POSITIONS.some(p => p === 'blank' ? fromUpdated.blank?.length > 0 : fromUpdated[p] != null);
              if (hasAny) next[fromDayKey] = fromUpdated; else delete next[fromDayKey];
            }
          }

          // 添加到目標位置
          if (pos === 'blank') {
            if (!updated.blank.includes(empId)) updated.blank.push(empId);
          } else {
            // 如果目標有員工，先移到 blank
            if (existingEmpId && existingEmpId !== empId) {
              updated.blank.push(existingEmpId);
            }
            updated[pos] = empId;
          }

          next[dayKey] = updated;
          return next;
        });
      };

      const totals = useMemo(() => {
        const t = Object.create(null); employees.forEach(e => t[e.id] = 0);
        Object.entries(assignments).forEach(([day, dayAsg]) => {
          const d = Number(day); const h = hoursForDate(year, month, d);
          if (!dayAsg) return;
          POSITIONS.forEach(pos => {
            const emps = getPositionEmps(dayAsg, pos);
            emps.forEach(id => { if (t[id] != null) t[id] += h; });
          });
        }); return t;
      }, [assignments, employees, year, month]);

      const trashRef = useRef(null);
      useEffect(() => {
        const el = trashRef.current; if (!el) return;
        const onDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
        const onDrop = (e) => {
          e.preventDefault();
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (data && data.fromDay && data.empId != null && data.fromPos) {
              removeFromPosition(data.fromDay, data.fromPos, data.empId);
            }
          } catch (_) { }
        };
        el.addEventListener('dragover', onDragOver); el.addEventListener('drop', onDrop);
        return () => { el.removeEventListener('dragover', onDragOver); el.removeEventListener('drop', onDrop); };
      }, []);

      // 分享：使用短碼 API
      const [shareLoading, setShareLoading] = useState(false);
      const copyShare = async (isReadOnly) => {
        setShareLoading(true);
        try {
          const payload = {
            v: 3,
            year,
            month,
            employees,
            colorMap,
            vacations,
            assignmentsByYM: { ...assignmentsByYM, [ymKey(year, month)]: assignments }
          };
          const res = await fetch(`${API_BASE}?action=share`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (res.ok) {
            const { code } = await res.json();
            const u = new URL(window.location.href);
            u.search = '';
            u.hash = '';
            u.searchParams.set('code', code);
            if (isReadOnly) u.searchParams.set('readOnly', '1');
            await navigator.clipboard.writeText(u.toString());
            setSaved(true); setTimeout(() => setSaved(false), 1500);
          } else {
            // Fallback: 使用舊版 hash 方式
            const u = new URL(window.location.href);
            u.hash = 's=' + encodeShareLegacy(payload);
            if (isReadOnly) u.searchParams.set('readOnly', '1'); else u.searchParams.delete('readOnly');
            await navigator.clipboard.writeText(u.toString());
            setSaved(true); setTimeout(() => setSaved(false), 1500);
          }
        } catch (e) {
          console.error('分享失敗', e);
          alert('分享失敗，請稍後再試');
        } finally {
          setShareLoading(false);
        }
      };

      return (
        <div className="h-full flex flex-col">
          <header className="border-b bg-white">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
              <h1 className="text-lg font-semibold text-slate-800">排班工具（週日為第一天）</h1>
              <span className="text-xs text-slate-500">週一到週五 7 小時，週末 6 小時</span>
              {readOnly && (<span className="ml-auto text-xs px-2 py-1 rounded bg-amber-100 text-amber-700">唯讀檢視</span>)}
            </div>
          </header>

          <main className="flex-1 max-w-7xl mx-auto w-full px-4 py-4 grid grid-cols-12 gap-4">
            <aside className="col-span-12 lg:col-span-4 xl:col-span-3 flex flex-col gap-4">
              <section className="bg-white border rounded-2xl p-4 shadow-sm">
                <div className="flex items-center justify-between"><div className="font-medium text-slate-700">員工名單</div></div>
                {!readOnly && (
                  <div className="mt-3 flex gap-2">
                    <input value={nameInput} onChange={(e) => setNameInput(e.target.value)} placeholder="輸入員工名字" className="flex-1 border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <button onClick={addEmployee} className="px-3 py-2 text-sm rounded-xl bg-blue-600 text-white hover:bg-blue-700">加入</button>
                  </div>
                )}
                <div className="mt-3 max-h-56 overflow-auto pr-1 scrollbar-thin">
                  {employees.length === 0 && (
                    <div className="flex items-center justify-between text-sm text-slate-500">
                      <span>尚無員工，請新增或建立示範資料。</span>
                      {!readOnly && <button onClick={seedDemo} className="text-blue-600 hover:underline">建立示範資料</button>}
                    </div>
                  )}
                  <ul className="flex flex-wrap gap-2">
                    {employees.map(emp => {
                      const color = getEmpColor(emp.id);
                      const hl = highlightEmpId === emp.id ? 'ring-2 ring-blue-300' : '';
                      return (
                        <li key={emp.id} className={`shrink-0 flex items-center gap-2 px-2 py-1 rounded-2xl border text-sm ${color} ${hl}`}
                          draggable={!readOnly}
                          onDragStart={(e) => onDragStartFromBadge(e, emp.id)}
                        >
                          <button
                            className="text-slate-800 hover:underline flex items-center gap-1 whitespace-nowrap"
                            onClick={() => setHighlightEmpId(highlightEmpId === emp.id ? null : emp.id)}
                            title={emp.name}
                          >
                            <span className="font-semibold sm:hidden">{abbr(emp.name)}</span>
                            <span className="hidden sm:inline truncate max-w-[10rem]">{emp.name}</span>
                          </button>
                          {!readOnly && (
                            <button
                              className="ml-1 text-[11px] px-2 py-0.5 rounded border text-rose-700 border-rose-300 hover:bg-rose-50"
                              onClick={(e) => { setVacEditEmp({ emp, anchor: { x: e.clientX, y: e.clientY } }); }}
                              title="設定休假日"
                            >假</button>
                          )}
                          {!readOnly && (
                            <button className="ml-auto text-xs text-slate-500 hover:text-red-500" onClick={() => removeEmployee(emp.id)} title="刪除員工">✕</button>
                          )}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              </section>

              {!readOnly && (
                <section className="bg-white border rounded-2xl p-4 shadow-sm">
                  <div className="font-medium text-slate-700">{monthLabel(year, month)} 本月總時數</div>
                  <div className="mt-3 max-h-64 overflow-auto pr-1 scrollbar-thin">
                    {employees.length === 0 ? (
                      <div className="text-sm text-slate-400">尚無資料</div>
                    ) : (
                      <table className="w-full text-sm">
                        <thead className="sticky top-0 bg-white">
                          <tr className="text-slate-400">
                            <th className="text-left font-normal py-1">員工</th>
                            <th className="text-right font-normal py-1">時數</th>
                          </tr>
                        </thead>
                        <tbody>
                          {employees.map(emp => (
                            <tr key={emp.id} className={"border-t " + (highlightEmpId === emp.id ? 'bg-blue-50' : '')}>
                              <td className="py-1">
                                <div className="flex items-center">
                                  <button className="text-slate-700 hover:underline flex items-center gap-1 whitespace-nowrap" onClick={() => setHighlightEmpId(highlightEmpId === emp.id ? null : emp.id)}>
                                    <span className="font-semibold sm:hidden">{abbr(emp.name)}</span>
                                    <span className="hidden sm:inline truncate max-w-[10rem]">{emp.name}</span>
                                  </button>
                                  {!readOnly && (
                                    <button
                                      className="ml-2 text-[11px] px-2 py-0.5 rounded border text-rose-700 border-rose-300 hover:bg-rose-50"
                                      onClick={(e) => { setVacEditEmp({ emp, anchor: { x: e.clientX, y: e.clientY } }); }}
                                      title="設定休假日"
                                    >假</button>
                                  )}
                                </div>
                              </td>
                              <td className="py-1 text-right tabular-nums">{totals[emp.id] || 0}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </section>
              )}

              {!readOnly && (
                <section ref={trashRef} className="bg-white border rounded-2xl p-4 shadow-sm">
                  <div className="font-medium text-slate-700">刪除區</div>
                  <p className="mt-2 text-sm text-slate-500">將日期中的名牌拖曳到此處可刪除。</p>
                </section>
              )}

              {!readOnly && (
                <section className="bg-white border rounded-2xl p-4 shadow-sm">
                  <div className="font-medium text-slate-700">雲端儲存與分享</div>
                  <div className="mt-3 flex flex-col gap-2">
                    <button onClick={saveRemote} className="px-3 py-2 rounded-2xl text-sm bg-emerald-600 text-white hover:bg-emerald-700">儲存到雲端（Netlify）</button>
                    <div className="flex gap-2">
                      <button onClick={() => copyShare(true)} className="flex-1 px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50">複製唯讀分享連結</button>
                      <button onClick={() => copyShare(false)} className="flex-1 px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50" title="允許他人共同編輯">複製可編輯連結</button>
                    </div>
                    {saved && <div className="text-xs text-emerald-700">已完成</div>}
                  </div>
                </section>
              )}

              {vacEditEmp && !readOnly && (
                <VacationPopover
                  emp={vacEditEmp.emp}
                  anchor={vacEditEmp.anchor}
                  baseYear={year}
                  baseMonth={month}
                  isVacation={isVacation}
                  toggleVacation={toggleVacation}
                  onClose={() => setVacEditEmp(null)}
                />
              )}
            </aside>

            <section className="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col gap-4">
              <div className="bg-white border rounded-2xl p-3 shadow-sm flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <button onClick={() => { let y = year, m = month - 1; if (m < 0) { m = 11; y--; } setYear(y); setMonth(m); setHighlightEmpId(null); }} className="px-2 py-1 rounded-lg border bg-white hover:bg-slate-50" title="上一個月">◀</button>
                  <div className="font-medium text-slate-800">{monthLabel(year, month)}</div>
                  <button onClick={() => { let y = year, m = month + 1; if (m > 11) { m = 0; y++; } setYear(y); setMonth(m); setHighlightEmpId(null); }} className="px-2 py-1 rounded-lg border bg-white hover:bg-slate-50" title="下一個月">▶</button>
                </div>
                {!readOnly && (
                  <button onClick={() => { if (confirm('清除本月所有排班？')) setAssignments({}); }} className="px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50">清空本月排班</button>
                )}
              </div>

              <div className="bg-white border rounded-2xl p-4 shadow-sm">
                <ScaleBox maxScale={1}>
                  <div className="w-[980px]">
                    <div className="grid grid-cols-7 gap-2 text-center text-slate-500 text-sm mb-2">
                      {['週日', '週一', '週二', '週三', '週四', '週五', '週六'].map((w) => (<div key={w} className="font-medium">{w}</div>))}
                    </div>
                    <div className="grid grid-cols-7 gap-2 auto-rows-fr">
                      {weeks.flat().map((c, idx) => c.type === 'pad' ? (
                        <div key={idx} className="min-h-36 rounded-2xl bg-slate-50 border border-dashed"></div>
                      ) : (
                        <CalendarCell
                          key={idx}
                          d={c.d}
                          year={year}
                          month={month}
                          readOnly={readOnly}
                          empList={employees}
                          dayAssign={(assignments[String(c.d)] || { S: null, P: null, F: null, M: null, blank: [] })}
                          highlightEmpId={highlightEmpId}
                          getEmpColor={getEmpColor}
                          onDrop={handleDrop}
                          onDragStartFromCell={onDragStartFromCell}
                          onRemove={removeFromPosition}
                          isVacation={isVacation}
                        />
                      ))}
                    </div>
                  </div>
                </ScaleBox>
              </div>
            </section>
          </main>
        </div>
      );
    }

    function CalendarCell({ d, year, month, empList, dayAssign, readOnly, highlightEmpId, getEmpColor, onDrop, onDragStartFromCell, onRemove, isVacation }) {
      const h = hoursForDate(year, month, d);

      // 檢查高亮員工是否在此日
      const allEmpsInDay = [...POSITIONS.filter(p => p !== 'blank').map(p => dayAssign[p]).filter(Boolean), ...(dayAssign.blank || [])];
      const isHL = highlightEmpId != null && allEmpsInDay.includes(highlightEmpId);
      const isVacHL = highlightEmpId != null && isVacation(highlightEmpId, year, month, d);

      return (
        <div className={("min-h-44 rounded-2xl border p-2 flex flex-col bg-white ") +
          (isHL ? ' ring-4 ring-blue-400 border-blue-400' : ' border-slate-200') + (isVacHL ? ' outline outline-2 outline-rose-400' : '')}
          title={isWeekend(year, month, d) ? '假日 6 小時' : '平日 7 小時'}>
          <div className="flex items-center justify-between text-xs text-slate-500 mb-1">
            <span className="font-medium text-slate-700">{d}</span>
            {!readOnly && (<span className="px-1 py-0.5 rounded bg-slate-100">{h}h</span>)}
          </div>

          <div className="flex-1 flex flex-col gap-0.5">
            {POSITIONS.map(pos => {
              const isBlank = pos === 'blank';
              const emps = isBlank ? (dayAssign.blank || []) : (dayAssign[pos] ? [dayAssign[pos]] : []);
              const label = isBlank ? '' : pos;

              return (
                <PositionRow
                  key={pos}
                  pos={pos}
                  label={label}
                  emps={emps}
                  empList={empList}
                  d={d}
                  year={year}
                  month={month}
                  readOnly={readOnly}
                  highlightEmpId={highlightEmpId}
                  getEmpColor={getEmpColor}
                  onDrop={onDrop}
                  onDragStartFromCell={onDragStartFromCell}
                  onRemove={onRemove}
                  isVacation={isVacation}
                  isBlank={isBlank}
                />
              );
            })}
          </div>
        </div>
      );
    }

    function PositionRow({ pos, label, emps, empList, d, year, month, readOnly, highlightEmpId, getEmpColor, onDrop, onDragStartFromCell, onRemove, isVacation, isBlank }) {
      const minH = isBlank ? 'min-h-[24px]' : 'h-[26px]';
      const bgColor = isBlank ? 'bg-slate-50' : 'bg-slate-100';

      const handleDragOver = (e) => {
        if (readOnly) return;
        e.preventDefault();
        e.stopPropagation();
      };

      const handleDrop = (e) => {
        if (readOnly) return;
        e.preventDefault();
        e.stopPropagation();
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          const empId = data?.empId;
          if (empId != null && isVacation(empId, year, month, d)) { return; }
          if (data && typeof empId !== 'undefined') {
            onDrop(d, pos, data);
          }
        } catch (err) {
          console.error('Drop error:', err);
        }
      };

      return (
        <div
          className={`${minH} ${bgColor} rounded px-1 py-0.5 flex items-start gap-1`}
          onDragOver={handleDragOver}
          onDrop={handleDrop}
        >
          {!isBlank && (
            <span
              className="text-[10px] font-bold text-slate-500 w-4 shrink-0 leading-tight"
              onDragOver={handleDragOver}
              onDrop={handleDrop}
            >{label}</span>
          )}
          <div
            className={`flex-1 flex ${isBlank ? 'flex-wrap' : ''} gap-0.5`}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
          >
            {emps.length === 0 ? (
              !readOnly && !isBlank ? (
                <span className="text-[9px] text-slate-300">-</span>
              ) : null
            ) : (
              emps.map((empId) => {
                const emp = empList.find(e => e.id === empId);
                if (!emp) return null;
                const isThisHL = highlightEmpId === empId;
                const color = getEmpColor(empId);
                const ring = isThisHL ? 'ring-1 ring-blue-300' : '';
                const vacToday = isVacation(empId, year, month, d);
                return (
                  <span
                    key={empId}
                    className={`group inline-flex items-center justify-center gap-0.5 text-xs font-medium leading-tight px-2 py-0.5 rounded border ${color} ${ring} ${vacToday ? ' border-rose-500' : ''} cursor-grab flex-1`}
                    draggable={!readOnly}
                    onDragStart={(e) => onDragStartFromCell(e, empId, d, pos)}
                    title={emp.name}
                  >
                    <span className="truncate">{emp.name}</span>
                    {vacToday && <span className="text-[8px] text-rose-700">休</span>}
                    {!readOnly && (
                      <button
                        className="opacity-0 group-hover:opacity-100 transition text-slate-500 hover:text-red-500 text-[10px]"
                        onClick={() => onRemove(d, pos, empId)}
                        title="移除"
                      >✕</button>
                    )}
                  </span>
                );
              })
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>
