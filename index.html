<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobby Bee 排班工具（Netlify 版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .calendar-inner { display: inline-block; transform-origin: top left; }
  </style>
</head>

<body class="bg-slate-50">
  <!-- Tailwind safelist -->
  <div class="hidden" aria-hidden="true">
    <span class="bg-red-200 border-red-700 text-red-900"></span>
    <span class="bg-orange-200 border-orange-700 text-orange-900"></span>
    <span class="bg-amber-200 border-amber-700 text-amber-900"></span>
    <span class="bg-emerald-200 border-emerald-700 text-emerald-900"></span>
    <span class="bg-teal-200 border-teal-700 text-teal-900"></span>
    <span class="bg-blue-200 border-blue-700 text-blue-900"></span>
    <span class="bg-violet-200 border-violet-700 text-violet-900"></span>
    <span class="bg-rose-200 border-rose-700 text-rose-900"></span>
    <span class="bg-cyan-200 border-cyan-700 text-cyan-900"></span>
    <span class="bg-indigo-200 border-indigo-700 text-indigo-900"></span>
    <span class="bg-lime-200 border-lime-700 text-lime-900"></span>
    <span class="bg-fuchsia-200 border-fuchsia-700 text-fuchsia-900"></span>
    <span class="bg-pink-200 border-pink-700 text-pink-900"></span>
    <span class="bg-purple-200 border-purple-700 text-purple-900"></span>
    <span class="bg-sky-200 border-sky-700 text-sky-900"></span>
    <span class="bg-slate-200 border-slate-700 text-slate-900"></span>
    <span class="bg-stone-200 border-stone-700 text-stone-900"></span>
    <span class="bg-green-200 border-green-700 text-green-900"></span>
  </div>

  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState, useLayoutEffect } = React;

    // === Utils（週日為每週第一天）===
    const ymKey = (y, m) => `${y}-${String(m + 1).padStart(2, '0')}`; // m:0-11
    const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
    const getDOW = (y, m, d) => new Date(y, m, d).getDay(); // 0..6 Sun..Sat
    const isWeekend = (y, m, d) => { const dow = getDOW(y, m, d); return dow === 0 || dow === 6; };
    const hoursForDate = (y, m, d) => (isWeekend(y, m, d) ? 6 : 7);
    const dateStr = (y,m,d) => `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    const encodeShare = (obj) => btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    const decodeShare = (str) => JSON.parse(decodeURIComponent(escape(atob(str))));

    const DISTINCT_KEYS = ['red','orange','amber','emerald','teal','blue','violet'];
    const EXTENDED_KEYS = [...DISTINCT_KEYS,'rose','cyan','indigo','lime','fuchsia','pink','purple','sky','slate','stone','green'];
    const colorClassForKey = (key) => `bg-${key}-200 border-${key}-700 text-${key}-900`;

    function hashStr(s){
      let h = 2166136261 >>> 0;
      for (let i=0; i<s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
      return h >>> 0;
    }
    function computeColorMap(employees, existingMap={}){
      const ids = new Set(employees.map(e=>e.id));
      const map = {};
      Object.keys(existingMap||{}).forEach(id=>{ if(ids.has(+id)||ids.has(id)) map[id]=existingMap[id]; });
      const used = new Set(Object.values(map));
      const unassigned = employees.filter(e=>map[e.id]==null).slice().sort((a,b)=>{
        const ha = hashStr(String(a.name||'').toLowerCase());
        const hb = hashStr(String(b.name||'').toLowerCase());
        return ha - hb;
      });
      const pickKey = () => {
        for(const k of DISTINCT_KEYS){ if(!used.has(k)) { used.add(k); return k; } }
        for(const k of EXTENDED_KEYS){ if(!used.has(k)) { used.add(k); return k; } }
        const arr = EXTENDED_KEYS; return arr[(used.size) % arr.length];
      };
      unassigned.forEach(e=>{ map[e.id] = pickKey(); });
      return map;
    }

    function buildMonthMatrix(year, month){
      const total = daysInMonth(year, month);
      const firstDow = new Date(year, month, 1).getDay(); // 0..6 Sun..Sat
      const leading = firstDow;
      const slots = leading + total;
      const weekCount = Math.ceil(slots / 7);
      const weeks = Array.from({length: weekCount}, ()=> Array(7).fill(null).map(()=>({type:'pad'})));
      let day = 1;
      for(let w=0; w<weekCount; w++){
        for(let dow=0; dow<7; dow++){
          const index = w*7 + dow;
          if(index >= leading && day <= total){
            weeks[w][dow] = {type:'day', d: day};
            day++;
          }
        }
      }
      return { weeks, weekCount };
    }

    function ScaleBox({ children, maxScale=1 }){
      const wrapRef = useRef(null);
      const innerRef = useRef(null);
      const [height, setHeight] = useState(null);
      useLayoutEffect(()=>{
        const wrap = wrapRef.current; const inner = innerRef.current; if(!wrap||!inner) return;
        const update = () => {
          inner.style.transform = 'scale(1)';
          const iw = inner.scrollWidth || inner.offsetWidth;
          const ih = inner.scrollHeight || inner.offsetHeight;
          const ww = wrap.clientWidth;
          const s = iw ? Math.min(ww/iw, maxScale) : 1;
          inner.style.transform = `scale(${s})`;
          setHeight(ih * s);
        };
        const ro = new ResizeObserver(update);
        ro.observe(wrap); ro.observe(inner);
        window.addEventListener('resize', update);
        update();
        return ()=>{ ro.disconnect(); window.removeEventListener('resize', update); };
      },[]);
      return (
        <div ref={wrapRef} className="w-full" style={{position:'relative', height: height?`${height}px`:'auto'}}>
          <div ref={innerRef} className="calendar-inner">{children}</div>
        </div>
      );
    }

    // ===== Netlify Blobs API（Functions 代理）=====
    const REMOTE_KEY = 'hb-default';
    const API_BASE = '/.netlify/functions/schedule';

    async function loadRemoteAll() {
      try {
        const res = await fetch(`${API_BASE}?key=${encodeURIComponent(REMOTE_KEY)}`);
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }
    async function saveRemoteAll(payload) {
      const res = await fetch(`${API_BASE}?key=${encodeURIComponent(REMOTE_KEY)}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok && res.status !== 204) throw new Error('儲存失敗');
    }

    // ===== Portal（休假彈窗）=====
    function Portal({ children }){
      const [node] = useState(()=> document.createElement('div'));
      useEffect(()=>{ document.body.appendChild(node); return ()=>{ document.body.removeChild(node); }; }, [node]);
      return ReactDOM.createPortal(children, node);
    }

    function VacationPopover({ emp, anchor, baseYear, baseMonth, onClose, isVacation, toggleVacation }) {
      const [off, setOff] = useState(0);
      const cur = new Date(baseYear, baseMonth + off, 1);
      const y = cur.getFullYear();
      const m = cur.getMonth();

      const [pos, setPos] = useState({ left: 0, top: 0 });
      useEffect(()=>{
        const PADDING = 12;
        const width = Math.min(window.innerWidth * 0.92, 560);
        const height = 380;
        let left = anchor.x; let top = anchor.y;
        if (left + width + PADDING > window.innerWidth) left = window.innerWidth - width - PADDING;
        if (top + height + PADDING > window.innerHeight) top = window.innerHeight - height - PADDING;
        if (left < PADDING) left = PADDING;
        if (top < PADDING) top = PADDING;
        setPos({ left, top });
      }, [anchor]);

      useEffect(()=>{
        const onKey = (e)=>{ if(e.key==='Escape') onClose(); };
        const onScroll = ()=> onClose();
        window.addEventListener('keydown', onKey);
        window.addEventListener('scroll', onScroll, { passive: true });
        return ()=>{ window.removeEventListener('keydown', onKey); window.removeEventListener('scroll', onScroll); };
      }, [onClose]);

      const { weeks } = useMemo(()=>buildMonthMatrix(y, m), [y, m]);

      return (
        <Portal>
          <div className="fixed inset-0 z-[99998]">
            <div className="absolute inset-0" onClick={onClose}></div>
            <div className="absolute z-[99999] p-4 bg-white border rounded-2xl shadow-2xl"
                 style={{ left: pos.left, top: pos.top, width: Math.min(window.innerWidth*0.92, 560) }}>
              <div className="flex items-center justify-between mb-3">
                <div className="text-base font-semibold text-slate-800">{emp.name} 的休假日</div>
                <div className="flex items-center gap-1">
                  <button className="px-2 py-1 rounded-lg border hover:bg-slate-50" title="上一月" onClick={()=>setOff(off-1)}>◀</button>
                  <div className="px-2 text-slate-700 font-medium">{y} 年 {String(m+1).padStart(2,'0')} 月</div>
                  <button className="px-2 py-1 rounded-lg border hover:bg-slate-50" title="下一月" onClick={()=>setOff(off+1)}>▶</button>
                  <button className="ml-2 px-2 py-1 rounded-lg border text-slate-500 hover:text-slate-700 hover:bg-slate-50" onClick={onClose} title="關閉">✕</button>
                </div>
              </div>
              <div className="grid grid-cols-7 gap-2 text-center text-sm text-slate-500 mb-2">
                {['日','一','二','三','四','五','六'].map((w)=> <div key={w} className="font-medium">{w}</div>)}
              </div>
              <div className="grid grid-cols-7 gap-2">
                {weeks.flat().map((c, idx) => c.type === 'pad' ? (
                  <div key={idx} className="h-10"></div>
                ) : (
                  <button key={idx}
                    onClick={()=>toggleVacation(emp.id, y, m, c.d)}
                    className={
                      "h-10 w-10 md:h-12 md:w-12 rounded-lg text-base md:text-lg leading-none flex items-center justify-center select-none transition " +
                      (isVacation(emp.id, y, m, c.d)
                       ? "bg-rose-100 border border-rose-500 text-rose-700 shadow-[inset_0_0_0_1px_rgba(244,63,94,0.2)]"
                       : "border border-slate-200 hover:bg-slate-50")}
                    title="點擊切換休假"
                  >{c.d}</button>
                ))}
              </div>
              <div className="mt-3 text-xs text-slate-500 flex items-center justify-between">
                <span>提示：紅色為休假，不可排班。按 ESC 或背景關閉。</span>
                <button className="px-2 py-1 rounded border hover:bg-slate-50" onClick={()=>setOff(0)}>回到本月</button>
              </div>
            </div>
          </div>
        </Portal>
      );
    }

    // ===== Roles（職位可重複，同職位多人；顯示排序 S>P>F>M>無職位，同職位內依加入順序）=====
    const ROLE_KEYS = ['S','P','F','M'];

    function roleRank(role){
      const idx = ROLE_KEYS.indexOf(role);
      return idx >= 0 ? idx : 999;
    }

    function normalizeDayEntry(entry){
      // Canonical: { order:[empId...], roleById:{[empId]: 'S'|'P'|'F'|'M'|null } }
      const empty = { order: [], roleById: {} };
      if (!entry) return empty;

      // Legacy A: [empId...]
      if (Array.isArray(entry)) {
        const roleById = {};
        const order = [];
        entry.forEach((id, idx) => {
          order.push(id);
          roleById[id] = ROLE_KEYS[idx % ROLE_KEYS.length] || null;
        });
        return { order: Array.from(new Set(order)), roleById };
      }

      // Legacy B (unique roles): { roles:{S,P,F,M}, order:[...] }
      if (entry && entry.roles && Array.isArray(entry.order)) {
        const roleById = {};
        for (const rk of ROLE_KEYS) {
          const id = entry.roles[rk];
          if (id != null) roleById[id] = rk;
        }
        entry.order.forEach(id => { if (roleById[id] == null) roleById[id] = null; });
        return { order: Array.from(new Set(entry.order)), roleById };
      }

      // Current
      const order = Array.isArray(entry.order) ? entry.order.slice() : [];
      const roleById = entry.roleById ? { ...entry.roleById } : {};
      order.forEach(id => { if (!(id in roleById)) roleById[id] = null; });
      return { order: Array.from(new Set(order)), roleById };
    }

    function findRoleOfEmp(dayEntry, empId){
      const d = normalizeDayEntry(dayEntry);
      return d.roleById?.[empId] ?? null;
    }

    function ensureEmpInOrder(dayEntry, empId){
      const d = normalizeDayEntry(dayEntry);
      if (!d.order.includes(empId)) d.order = [...d.order, empId];
      if (!(empId in d.roleById)) d.roleById[empId] = null;
      return d;
    }

    function removeEmpFromDayEntry(dayEntry, empId){
      const d = normalizeDayEntry(dayEntry);
      d.order = d.order.filter(id => id !== empId);
      if (d.roleById) delete d.roleById[empId];
      return d;
    }

    function addEmpAuto(dayEntry, empId){
      let d = normalizeDayEntry(dayEntry);
      if (d.order.includes(empId)) return d;

      d = ensureEmpInOrder(d, empId);

      // Default role by insertion position: 1st S, 2nd P, 3rd F, 4th M, 5th S...
      const idx = d.order.indexOf(empId);
      d.roleById[empId] = ROLE_KEYS[idx % ROLE_KEYS.length];
      return d;
    }

    function setEmpRole(dayEntry, empId, nextRole){
      let d = ensureEmpInOrder(dayEntry, empId);
      d.roleById[empId] = nextRole || null;
      return d;
    }

    function cycleRole(currentRole){
      if (!currentRole) return 'S';
      const idx = ROLE_KEYS.indexOf(currentRole);
      if (idx < 0) return 'S';
      return (idx === ROLE_KEYS.length - 1) ? null : ROLE_KEYS[idx + 1];
    }

    function reorderInDay(dayEntry, fromIndex, toIndex){
      const d = normalizeDayEntry(dayEntry);
      const arr = d.order.slice();
      const from = Math.max(0, Math.min(fromIndex, arr.length - 1));
      const to = Math.max(0, Math.min(toIndex, arr.length));
      const [item] = arr.splice(from, 1);
      arr.splice(to, 0, item);
      d.order = arr;
      return d;
    }

    function getDisplayOrder(dayEntry){
      const d = normalizeDayEntry(dayEntry);
      const indexMap = new Map(d.order.map((id, i) => [id, i]));
      return d.order.slice().sort((a,b)=>{
        const ra = roleRank(d.roleById?.[a]);
        const rb = roleRank(d.roleById?.[b]);
        if (ra !== rb) return ra - rb;
        return (indexMap.get(a) ?? 0) - (indexMap.get(b) ?? 0);
      });
    }

    function isDayEntryEmpty(dayEntry){
      const d = normalizeDayEntry(dayEntry);
      return (d.order || []).length === 0;
    }

    // ===== App =====
    function App() {

// 預設自動跳到當月份
const today = new Date();
const [year, setYear] = useState(today.getFullYear());
const [month, setMonth] = useState(today.getMonth()); // 0-11


      const [nameInput, setNameInput] = useState("");
      const [employees, setEmployees] = useState([]);
      const [assignments, setAssignments] = useState({}); // 當月：day -> dayEntry
      const [assignmentsByYM, setAssignmentsByYM] = useState({}); // 全部月份
      const [colorMap, setColorMap] = useState({});
      const [vacations, setVacations] = useState({}); // { [empId]: { 'YYYY-MM-DD': true } }

      const [highlightEmpId, setHighlightEmpId] = useState(null);
      const [readOnly, setReadOnly] = useState(false);
      const [saved, setSaved] = useState(false);

      const [vacEditEmp, setVacEditEmp] = useState(null); // {emp, anchor:{x,y}}

      // 解析唯讀/分享
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        setReadOnly(params.get('readOnly') === '1');
        const hash = window.location.hash || '';
        if (hash.startsWith('#s=')) {
          try {
            const payload = decodeShare(hash.slice(3));
            if (payload && (payload.v === 1 || payload.v === 2 || payload.v === 3)) {
              setYear(payload.year); setMonth(payload.month);
              setEmployees(payload.employees || []);
              if (payload.assignmentsByYM) {
                setAssignmentsByYM(payload.assignmentsByYM);
                setAssignments(payload.assignmentsByYM[ymKey(payload.year, payload.month)] || {});
              } else {
                setAssignments(payload.assignments || {});
              }
              setColorMap(payload.colorMap || {});
              setVacations(payload.vacations || {});
              setReadOnly(true);
            }
          } catch (e) {
            console.warn('共享連結解析失敗', e);
          }
        }
      }, []);

      // 啟動時載入雲端資料
      useEffect(() => {
        (async () => {
          const remote = await loadRemoteAll();
          if (remote) {
            setEmployees(remote.employees || []);
            setColorMap(remote.colorMap || {});
            setVacations(remote.vacations || {});
            const byYM = remote.assignmentsByYM || {};
            setAssignmentsByYM(byYM);
            setAssignments(byYM[ymKey(year, month)] || {});
          }
        })();
      }, []);

      // 員工顏色保持穩定
      useEffect(() => {
        const next = computeColorMap(employees, colorMap);
        if (JSON.stringify(next) !== JSON.stringify(colorMap)) setColorMap(next);
      }, [employees]);

      // 切換月份時載入當月資料
      useEffect(() => {
        setAssignments(assignmentsByYM[ymKey(year, month)] || {});
      }, [year, month, assignmentsByYM]);

      const { weeks } = useMemo(()=>buildMonthMatrix(year, month), [year, month]);

      const isVacation = (empId, y, m, d) => !!vacations?.[empId]?.[dateStr(y,m,d)];
      const toggleVacation = (empId, y, m, d) => {
        setVacations(prev => {
          const ds = dateStr(y,m,d);
          const cur = { ...(prev[empId] || {}) };
          if (cur[ds]) delete cur[ds]; else cur[ds] = true;
          return { ...prev, [empId]: cur };
        });
      };

      const saveRemote = async () => {
        const ym = ymKey(year, month);
        const merged = { ...assignmentsByYM, [ym]: assignments };
        const payload = { employees, colorMap, vacations, assignmentsByYM: merged };
        await saveRemoteAll(payload);
        setAssignmentsByYM(merged);
        setSaved(true); setTimeout(()=>setSaved(false), 1500);
      };

      const monthLabel = (y, m) => `${y} 年 ${String(m+1).padStart(2,'0')} 月`;
      const abbr = (name) => (name || '').trim().slice(0,3).toUpperCase();

      const getEmpColor = (empId) => colorClassForKey(colorMap[empId] || 'emerald');

      const addEmployee = () => {
        if (readOnly) return;
        const name = nameInput.trim();
        if (!name) return;
        const id = Date.now() + Math.random();
        const newEmp = { id, name };
        const nextEmployees = [...employees, newEmp];
        const nextMap = computeColorMap(nextEmployees, colorMap);
        setEmployees(nextEmployees);
        setColorMap(nextMap);
        setNameInput("");
      };

      const removeEmployee = (empId) => {
        if (readOnly) return;
        setEmployees(prev => prev.filter(e => e.id !== empId));
        setAssignments(prev => {
          const next = { ...prev };
          Object.keys(next).forEach(day => {
            const cleaned = removeEmpFromDayEntry(next[day], empId);
            if (isDayEntryEmpty(cleaned)) delete next[day];
            else next[day] = cleaned;
          });
          return next;
        });
        setVacations(prev => { const n={...prev}; delete n[empId]; return n; });
        setColorMap(prev => { const n={...prev}; delete n[empId]; return n; });
        if (highlightEmpId===empId) setHighlightEmpId(null);
      };

      const seedDemo = () => {
        const base = Date.now();
        const emps = [
          { id: base+1, name: 'Alice' },
          { id: base+2, name: 'Ben' },
          { id: base+3, name: 'Cindy' },
          { id: base+4, name: 'David' },
          { id: base+5, name: 'Emma' },
          { id: base+6, name: 'Frank' },
          { id: base+7, name: 'Gina' },
        ];

        let d2 = null; d2 = addEmpAuto(d2, emps[0].id); d2 = addEmpAuto(d2, emps[1].id);
        let d5 = null; d5 = addEmpAuto(d5, emps[2].id);
        let d9 = null;
        d9 = addEmpAuto(d9, emps[3].id);
        d9 = addEmpAuto(d9, emps[0].id);
        d9 = addEmpAuto(d9, emps[1].id);
        d9 = addEmpAuto(d9, emps[2].id);
        d9 = addEmpAuto(d9, emps[4].id);

        setEmployees(emps);
        setAssignments({ '2': d2, '5': d5, '9': d9 });
        setColorMap(computeColorMap(emps, {}));
        setVacations({
          [emps[0].id]: { [dateStr(2025,8,7)]: true, [dateStr(2025,8,14)]: true },
          [emps[2].id]: { [dateStr(2025,8,5)]: true },
        });
      };

      // Drag sources
      const onDragStartFromBadge = (e, empId) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ empId }));
        e.dataTransfer.effectAllowed = 'copy';
      };
      const onDragStartFromCell = (e, empId, day, index) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ empId, fromDay: day, fromIndex: index }));
        e.dataTransfer.effectAllowed = 'move';
      };

      // Mutations
      const addToDay = (day, empId) => {
        setAssignments(prev => {
          const next = { ...prev };
          const key = String(day);
          next[key] = addEmpAuto(next[key], empId);
          return next;
        });
      };

      const removeFromDay = (day, empId) => {
        setAssignments(prev => {
          const next = { ...prev };
          const key = String(day);
          const cleaned = removeEmpFromDayEntry(next[key], empId);
          if (isDayEntryEmpty(cleaned)) delete next[key];
          else next[key] = cleaned;
          return next;
        });
      };

      // Drop payload (from list or from cell)
      const moveOrCopyToDay = (day, payload) => {
        const { empId, fromDay, fromIndex, dropIndex } = payload || {};
        if (empId == null) return;

        setAssignments(prev => {
          const next = { ...prev };
          const dstKey = String(day);

          // Move within same day: reorder base order (tie-breaker within same role group)
          if (fromDay && Number(fromDay) === Number(day) && typeof fromIndex === 'number' && typeof dropIndex === 'number') {
            next[dstKey] = reorderInDay(next[dstKey], fromIndex, dropIndex);
            return next;
          }

          // Remove from source day if moving from another day
          if (fromDay) {
            const srcKey = String(fromDay);
            const cleaned = removeEmpFromDayEntry(next[srcKey], empId);
            if (isDayEntryEmpty(cleaned)) delete next[srcKey];
            else next[srcKey] = cleaned;
          }

          // Add to target day
          let dst = addEmpAuto(next[dstKey], empId);

          // Reorder to end by default
          if (typeof dropIndex === 'number') {
            const baseOrder = normalizeDayEntry(dst).order;
            const idx = baseOrder.indexOf(empId);
            if (idx >= 0) dst = reorderInDay(dst, idx, dropIndex);
          }

          next[dstKey] = dst;
          return next;
        });
      };

      const setRoleForDay = (day, empId, roleOrNull) => {
        setAssignments(prev => {
          const next = { ...prev };
          const key = String(day);
          next[key] = setEmpRole(next[key], empId, roleOrNull);
          return next;
        });
      };

      const totals = useMemo(() => {
        const t = Object.create(null);
        employees.forEach(e => t[e.id] = 0);
        Object.entries(assignments).forEach(([day, entry]) => {
          const d = Number(day);
          const h = hoursForDate(year, month, d);
          const norm = normalizeDayEntry(entry);
          norm.order.forEach(id => { if (t[id] != null) t[id] += h; });
        });
        return t;
      }, [assignments, employees, year, month]);

      // Trash drop
      const trashRef = useRef(null);
      useEffect(() => {
        const el = trashRef.current; if (!el) return;
        const onDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
        const onDrop = (e) => {
          e.preventDefault();
          try {
            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            if (data && data.fromDay && data.empId != null) removeFromDay(data.fromDay, data.empId);
          } catch {}
        };
        el.addEventListener('dragover', onDragOver);
        el.addEventListener('drop', onDrop);
        return () => { el.removeEventListener('dragover', onDragOver); el.removeEventListener('drop', onDrop); };
      }, []);

      // Share
      const makeShareUrl = (isReadOnly) => {
        const payload = {
          v: 3, year, month, employees, colorMap, vacations,
          assignmentsByYM: { ...assignmentsByYM, [ymKey(year, month)]: assignments }
        };
        const u = new URL(window.location.href);
        u.hash = 's=' + encodeShare(payload);
        if (isReadOnly) u.searchParams.set('readOnly', '1'); else u.searchParams.delete('readOnly');
        return u.toString();
      };
      const copyShare = async (isReadOnly) => {
        const url = makeShareUrl(isReadOnly);
        await navigator.clipboard.writeText(url);
        setSaved(true); setTimeout(()=>setSaved(false), 1500);
      };

      return (
        <div className="h-full flex flex-col">
          <header className="border-b bg-white">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
              <h1 className="text-lg font-semibold text-slate-800">排班工具（Netlify 版）</h1>
              <span className="text-xs text-slate-500">週一到週五 7 小時，週末 6 小時</span>
              {readOnly && (<span className="ml-auto text-xs px-2 py-1 rounded bg-amber-100 text-amber-700">唯讀檢視</span>)}
            </div>
          </header>

          <main className="flex-1 max-w-7xl mx-auto w-full px-4 py-4 grid grid-cols-12 gap-4">
            <aside className="col-span-12 lg:col-span-4 xl:col-span-3 flex flex-col gap-4">
              <section className="bg-white border rounded-2xl p-4 shadow-sm">
                <div className="flex items-center justify-between">
                  <div className="font-medium text-slate-700">員工名單</div>
                </div>

                {!readOnly && (
                  <div className="mt-3 flex gap-2">
                    <input
                      value={nameInput}
                      onChange={(e)=>setNameInput(e.target.value)}
                      placeholder="輸入員工名字"
                      className="flex-1 border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <button onClick={addEmployee} className="px-3 py-2 text-sm rounded-xl bg-blue-600 text-white hover:bg-blue-700">加入</button>
                  </div>
                )}

                <div className="mt-3 max-h-56 overflow-auto pr-1 scrollbar-thin">
                  {employees.length === 0 && (
                    <div className="flex items-center justify-between text-sm text-slate-500">
                      <span>尚無員工，請新增或建立示範資料。</span>
                      {!readOnly && <button onClick={seedDemo} className="text-blue-600 hover:underline">建立示範資料</button>}
                    </div>
                  )}

                  <ul className="flex flex-wrap gap-2">
                    {employees.map(emp => {
                      const color = getEmpColor(emp.id);
                      const hl = highlightEmpId===emp.id ? 'ring-2 ring-blue-300' : '';
                      return (
                        <li
                          key={emp.id}
                          className={`shrink-0 flex items-center gap-2 px-2 py-1 rounded-2xl border text-sm ${color} ${hl}`}
                          draggable={!readOnly}
                          onDragStart={(e)=>onDragStartFromBadge(e, emp.id)}
                        >
                          <button
                            className="text-slate-800 hover:underline flex items-center gap-1 whitespace-nowrap"
                            onClick={()=> setHighlightEmpId(highlightEmpId===emp.id? null: emp.id)}
                            title={emp.name}
                          >
                            <span className="font-semibold sm:hidden">{abbr(emp.name)}</span>
                            <span className="hidden sm:inline truncate max-w-[10rem]">{emp.name}</span>
                          </button>

                          {!readOnly && (
                            <button
                              className="ml-1 text-[11px] px-2 py-0.5 rounded border text-rose-700 border-rose-300 hover:bg-rose-50"
                              onClick={(e)=> { setVacEditEmp({ emp, anchor: { x: e.clientX, y: e.clientY } }); }}
                              title="設定休假日"
                            >假</button>
                          )}

                          {!readOnly && (
                            <button
                              className="ml-auto text-xs text-slate-500 hover:text-red-500"
                              onClick={()=>removeEmployee(emp.id)}
                              title="刪除員工"
                            >✕</button>
                          )}
                        </li>
                      );
                    })}
                  </ul>
                </div>
              </section>

              {!readOnly && (
                <section className="bg-white border rounded-2xl p-4 shadow-sm">
                  <div className="font-medium text-slate-700">{monthLabel(year, month)} 本月總時數</div>
                  <div className="mt-3 max-h-64 overflow-auto pr-1 scrollbar-thin">
                    {employees.length === 0 ? (
                      <div className="text-sm text-slate-400">尚無資料</div>
                    ) : (
                      <table className="w-full text-sm">
                        <thead className="sticky top-0 bg-white">
                          <tr className="text-slate-400">
                            <th className="text-left font-normal py-1">員工</th>
                            <th className="text-right font-normal py-1">時數</th>
                          </tr>
                        </thead>
                        <tbody>
                          {employees.map(emp => (
                            <tr key={emp.id} className={"border-t " + (highlightEmpId===emp.id? 'bg-blue-50':'') }>
                              <td className="py-1">
                                <div className="flex items-center">
                                  <button className="text-slate-700 hover:underline flex items-center gap-1 whitespace-nowrap"
                                          onClick={()=> setHighlightEmpId(highlightEmpId===emp.id? null: emp.id)}>
                                    <span className="font-semibold sm:hidden">{abbr(emp.name)}</span>
                                    <span className="hidden sm:inline truncate max-w-[10rem]">{emp.name}</span>
                                  </button>
                                  <button
                                    className="ml-2 text-[11px] px-2 py-0.5 rounded border text-rose-700 border-rose-300 hover:bg-rose-50"
                                    onClick={(e)=> { setVacEditEmp({ emp, anchor: { x: e.clientX, y: e.clientY } }); }}
                                    title="設定休假日"
                                  >假</button>
                                </div>
                              </td>
                              <td className="py-1 text-right tabular-nums">{totals[emp.id] || 0}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </section>
              )}

              {!readOnly && (
                <section ref={trashRef} className="bg-white border rounded-2xl p-4 shadow-sm">
                  <div className="font-medium text-slate-700">刪除區</div>
                  <p className="mt-2 text-sm text-slate-500">將日期中的名牌拖曳到此處可刪除。</p>
                </section>
              )}

              <section className="bg-white border rounded-2xl p-4 shadow-sm">
                <div className="font-medium text-slate-700">雲端儲存與分享</div>
                <div className="mt-3 flex flex-col gap-2">
                  {!readOnly && (
                    <button onClick={saveRemote} className="px-3 py-2 rounded-2xl text-sm bg-emerald-600 text-white hover:bg-emerald-700">
                      儲存到雲端（Netlify）
                    </button>
                  )}
                  <div className="flex gap-2">
                    <button onClick={()=>copyShare(true)} className="flex-1 px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50">
                      複製唯讀分享連結
                    </button>
                    {!readOnly && (
                      <button onClick={()=>copyShare(false)} className="flex-1 px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50" title="允許他人共同編輯">
                        複製可編輯連結
                      </button>
                    )}
                  </div>
                  {saved && <div className="text-xs text-emerald-700">已完成</div>}
                </div>
              </section>

              {vacEditEmp && !readOnly && (
                <VacationPopover
                  emp={vacEditEmp.emp}
                  anchor={vacEditEmp.anchor}
                  baseYear={year}
                  baseMonth={month}
                  isVacation={isVacation}
                  toggleVacation={toggleVacation}
                  onClose={()=>setVacEditEmp(null)}
                />
              )}
            </aside>

            <section className="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col gap-4">
              <div className="bg-white border rounded-2xl p-3 shadow-sm flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <button
                    onClick={()=>{
                      let y=year, m=month-1; if(m<0){m=11;y--;}
                      setYear(y); setMonth(m); setHighlightEmpId(null);
                    }}
                    className="px-2 py-1 rounded-lg border bg-white hover:bg-slate-50"
                    title="上一個月"
                  >◀</button>

                  <div className="font-medium text-slate-800">{monthLabel(year, month)}</div>

                  <button
                    onClick={()=>{
                      let y=year, m=month+1; if(m>11){m=0;y++;}
                      setYear(y); setMonth(m); setHighlightEmpId(null);
                    }}
                    className="px-2 py-1 rounded-lg border bg-white hover:bg-slate-50"
                    title="下一個月"
                  >▶</button>
                </div>

                {!readOnly && (
                  <button
                    onClick={()=>{ if (confirm('清除本月所有排班？')) setAssignments({}); }}
                    className="px-3 py-2 rounded-2xl text-sm border bg-white hover:bg-slate-50"
                  >
                    清空本月排班
                  </button>
                )}
              </div>

              <div className="bg-white border rounded-2xl p-4 shadow-sm">
                <ScaleBox maxScale={1}>
                  <div className="w-[980px]">
                    <div className="grid grid-cols-7 gap-2 text-center text-slate-500 text-sm mb-2">
                      {['週日','週一','週二','週三','週四','週五','週六'].map((w) => (<div key={w} className="font-medium">{w}</div>))}
                    </div>

                    <div className="grid grid-cols-7 gap-2 auto-rows-fr">
                      {weeks.flat().map((c, idx) => c.type === 'pad' ? (
                        <div key={idx} className="min-h-36 rounded-2xl bg-slate-50 border border-dashed"></div>
                      ) : (
                        <CalendarCell
                          key={idx}
                          d={c.d}
                          year={year}
                          month={month}
                          readOnly={readOnly}
                          empList={employees}
                          dayEntry={assignments[String(c.d)]}
                          highlightEmpId={highlightEmpId}
                          getEmpColor={getEmpColor}
                          onDropPayload={moveOrCopyToDay}
                          onAdd={(empId)=>addToDay(c.d, empId)}
                          onRemove={(empId)=>removeFromDay(c.d, empId)}
                          onSetRole={(empId, roleOrNull)=>setRoleForDay(c.d, empId, roleOrNull)}
                          onDragStartFromCell={onDragStartFromCell}
                          isVacation={isVacation}
                        />
                      ))}
                    </div>
                  </div>
                </ScaleBox>
              </div>
            </section>
          </main>
        </div>
      );
    }

    function CalendarCell({
      d, year, month, empList, dayEntry,
      readOnly, highlightEmpId, getEmpColor,
      onDropPayload, onAdd, onRemove, onSetRole,
      onDragStartFromCell,
      isVacation
    }) {
      const h = hoursForDate(year, month, d);
      const norm = useMemo(() => normalizeDayEntry(dayEntry), [dayEntry]);

      // 依 S>P>F>M>無職位 顯示排序（同職位內依加入順序）
      const assignedAll = useMemo(() => getDisplayOrder(norm), [norm]);

      const isHL = highlightEmpId != null && assignedAll.includes(highlightEmpId);
      const isVacHL = highlightEmpId != null && isVacation(highlightEmpId, year, month, d);

      const allowDrop = (e) => {
        if (readOnly) return false;
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          const empId = data?.empId;
          if (empId != null && isVacation(empId, year, month, d)) return false;
        } catch {}
        return true;
      };

      const roleBadge = (role) => {
        if (!role) return { txt: '', cls: 'bg-slate-200 text-slate-700' };
        const map = {
          S: { txt:'S', cls:'bg-rose-500 text-white' },
          P: { txt:'P', cls:'bg-amber-500 text-white' },
          F: { txt:'F', cls:'bg-emerald-600 text-white' },
          M: { txt:'M', cls:'bg-indigo-600 text-white' },
        };
        return map[role] || { txt: role, cls:'bg-slate-500 text-white' };
      };

      const renderChip = (empId, displayIndex) => {
        const emp = empList.find(e => e.id === empId);
        if (!emp) return null;

        const role = findRoleOfEmp(norm, empId);
        const rb = roleBadge(role);

        const isThisHL = highlightEmpId === empId;
        const ring = isThisHL ? 'ring-2 ring-blue-300' : '';
        const color = getEmpColor(empId);
        const vacToday = isVacation(empId, year, month, d);

        const onCycle = () => {
          if (readOnly) return;
          const next = cycleRole(role);
          onSetRole(empId, next);
        };

        // 重要：拖曳排序使用 base order 的 index（不是 displayIndex）
        const baseIndex = normalizeDayEntry(norm).order.indexOf(empId);

        return (
          <li
            key={empId}
            className={"flex items-center gap-2 px-2 py-1 rounded-xl border " + color + " " + ring + (vacToday ? ' border-rose-500' : '')}
            draggable={!readOnly}
            onDragStart={(e)=>onDragStartFromCell(e, empId, d, baseIndex)}
            title={emp.name}
          >
            <button
              type="button"
              onClick={onCycle}
              className={"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0 " + rb.cls + (readOnly ? ' cursor-default' : ' hover:opacity-90')}
              title={readOnly ? '' : '點擊切換職位'}
            >
              {rb.txt}
            </button>

            <div className="min-w-0 flex-1">
              <div className="text-[12px] font-medium text-slate-900 truncate">{emp.name}</div>
            </div>

            {!readOnly && (
              <button
                className="text-slate-500 hover:text-red-500 text-sm"
                onClick={()=>onRemove(empId)}
                title="移除"
              >
                ✕
              </button>
            )}
          </li>
        );
      };

      // Capture：整格都能接 drop，就算滑在名牌上也能放入
      const onDragOverCapture = (e) => {
        if (!allowDrop(e)) { e.dataTransfer.dropEffect = 'none'; return; }
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
      };

      const onDropCapture = (e) => {
        if (!allowDrop(e)) return;
        e.preventDefault();
        try {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          const empId = data?.empId;
          if (empId == null) return;

          // 預設放到最後（base order）
          if (data.fromDay) onDropPayload(d, { ...data, dropIndex: normalizeDayEntry(norm).order.length });
          else onAdd(empId);
        } catch {}
      };

      return (
        <div
          className={("min-h-36 rounded-2xl border p-2 flex flex-col gap-2 bg-white ") +
            (isHL? ' ring-4 ring-blue-400 border-blue-400' : ' border-slate-200') +
            (isVacHL ? ' outline outline-2 outline-rose-400' : '')
          }
          onDragOverCapture={onDragOverCapture}
          onDropCapture={onDropCapture}
          title={isWeekend(year, month, d) ? '假日 6 小時' : '平日 7 小時'}
        >
          <div className="flex items-center justify-between text-xs text-slate-500">
            <span className="font-medium text-slate-700">{d}</span>
            {!readOnly && (<span className="px-1 py-0.5 rounded bg-slate-100">{h} 小時</span>)}
          </div>

          {assignedAll.length === 0 ? (
            !readOnly ? (
              <div className="text-xs text-slate-300 select-none flex-1">可拖曳名牌到此</div>
            ) : (
              <div className="h-4"></div>
            )
          ) : (
            <ul className="flex flex-col gap-1">
              {assignedAll.map((empId, idx) => renderChip(empId, idx))}
            </ul>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
